<?php
ini_set('memory_limit', '4096M');
error_reporting(E_ERROR);

include 'db_config.php';

pdoconnect_db();
global $pdo;
$pdo->query( 'use imdbvisualization' );


global $pdo;
global $array_exclude;
$sql = "SELECT * FROM `options` where id =4 limit 1";

$q = $pdo->prepare($sql);
$q->execute();
$r = $q->fetch();
$val = $r['val'];
$array_exclude = [];
$val = str_replace('\\', '', $val);
$array_exclude = explode(',', $val);
foreach ($array_exclude as $index => $val) {
    $array_exclude[$index] = trim(str_replace("'", "", $val));
}
///var_dump($array_exclude);

global $array_compare;
$array_compare = [];
$sql = "SELECT * FROM `options` where id =3 limit 1";

$q = $pdo->prepare($sql);
$q->execute();
$r = $q->fetch();
$val = $r['val'];
$val = str_replace('\\', '', $val);
$array_compare_0 = explode("',", $val);
foreach ($array_compare_0 as $val) {
    $val = trim($val);
    // echo $val.' ';
    $result = explode('=>', $val);
    ///var_dump($result);
    $index = trim(str_replace("'", "", $result[0]));
    $value = trim(str_replace("'", "", $result[1]));

    $regv = '#([A-Za-z\,\(\)\- ]{1,})#';

    if (preg_match($regv, $index, $mach)) {
        $index = $mach[1];
    }


    $index = trim($index);

    $array_compare[$index] = $value;
}
global $array_ethnic_color;



if (isset($_POST['data']))
{
    $data = ($_POST['data']);
    $data_object = json_decode($data);

    $selected_color =  $data_object->color;





}


if ($selected_color=='default')
{
/*
    ?>

    <style type="text/css">
        .highcharts-color-0 {
            fill: #2b908f!important;
            stroke: #2b908f!important;
        }

        .highcharts-color-1 {
            fill: #90ee7e!important;
            stroke: #90ee7e!important;
        }

        .highcharts-color-2 {
            fill: #f45b5b!important;
            stroke: #f45b5b!important;
        }

        .highcharts-color-3 {
            fill: #7798BF!important;
            stroke: #7798BF!important;
        }

        .highcharts-color-4 {
            fill: #aaeeee!important;
            stroke: #aaeeee!important;
        }

        .highcharts-color-5 {
            fill: #ff0066;
            stroke: #ff0066;
        }

        .highcharts-color-6 {
            fill: #eeaaee!important;
            stroke: #eeaaee!important;
        }

        .highcharts-color-7 {
            fill: #55BF3B!important;
            stroke: #55BF3B!important;
        }

        .highcharts-color-8 {
            fill: #DF5353!important;
            stroke: #DF5353!important;
        }

        .highcharts-color-9 {
            fill: #7798BF!important;
            stroke: #7798BF!important;
        }

        .highcharts-color-10 {
            fill: #aaeeee!important;
            stroke: #aaeeee!important;
        }

        .highcharts-color-11 {
            fill: #0006ee!important;
            stroke: #0006ee!important;
        }


        .highcharts-color-12 {
            fill: #ee002d!important;
            stroke: #ee002d!important;
        }
        .highcharts-color-13 {
            fill: #eece00!important;
            stroke: #eece00!important;
        }
        .highcharts-color-14 {
            fill: #00ee1a!important;
            stroke: #00ee1a!important;
        }
        .highcharts-color-15 {
            fill: #0076ee!important;
            stroke: #0076ee!important;
        }
    </style>


    <?php
*/



    $array_ethnic_color =array(

        'White'=>'#2b908f',
        'Asian'=>'#90ee7e',
        'Black'=>'#f45b5b',
        'Dark Asian'=>'#7798BF',
        'Indigenous'=>'#aaeeee',
        'Jewish'=>'#ff0066',
        'Latino'=>'#eeaaee',
        'Mixed / Other'=>'#55BF3B',
        'Arab'=>'#DF5353',

        'Male'=>'#2b908f',
        'Female'=>'#90ee7e',

        'White (+ Jews )'=>'#2b908f',
        'non-White'=>'#90ee7e',

        'White (- Jews )'=>'#2b908f',
        'non-White (+ Jews)'=>'#90ee7e',

        'White Male (+ Jews )'=>'#2b908f',
        'non-Whites ( + Female Whites )'=>'#90ee7e',

        'White Male (- Jews )'=>'#2b908f',
        'non-Whites ( + Jews + Female Whites )'=>'#90ee7e',

        'Box Office International'=>'#2b908f',
        'Box Office Domestic'=>'#90ee7e',

        'Box Office per movie'=>'#0006ee',
        'Box Office total'=>'#00ee1a'
    );


}
else {
    $array_ethnic_color = [];

    $sql = "SELECT * FROM `options` where id =6 limit 1";

    $q = $pdo->prepare($sql);
    $q->execute();
    $r = $q->fetch();
    $val = $r['val'];
    $val = str_replace('\\', '', $val);
    $array_compare_0 = explode("',", $val);
    foreach ($array_compare_0 as $val) {
        $val = trim($val);
        // echo $val.' ';
        $result = explode('=>', $val);
        ///var_dump($result);
        $index = trim(str_replace("'", "", $result[0]));
        $value = trim(str_replace("'", "", $result[1]));
        $index = trim($index);
        $array_ethnic_color[$index] = $value;
    }
}

//var_dump($array_compare);

global $array_convert_k;
global $array_convert_kf;
$array_convert_k = array(
    'EA' => 'East Asian',
    'J' => 'Japanese',
    'I' => 'Indian',
    'B' => 'African',
    'M' => 'Muslim',
    'W' => 'British',
    'EE' => 'East European',
    'JW' => 'Jewish',
    'F' => 'French',
    'G' => 'German',
    'H' => 'Hispanic',
    'It' => 'Italian',
    'N' => 'Nordic');

$array_convert_kf = array(
    'A' => 'Asian',
    'B' => 'Black',
    'H' => 'Hispanic',
    'W' => 'White',
    'O' => 'Other');




function set_table_ethnic($data,$country='')
{
    global $pdo;

    $array_population = [];



    if ($country)
    {
     ///   echo $country;

        $array_countries = array('USA'=>'United States','UK'=>'United Kingdom','Russia (CIS)'=>'Russia');

        if ($array_countries[$country])
        {
            $country = $array_countries[$country];
        }

        $sql = "SELECT ethnic_array_result  FROM data_population_country  WHERE `country_name` = '".$country."' limit 1";

        $q = $pdo->prepare($sql);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);

       $r = $q->fetch();

           $ethnic = $r['ethnic_array_result'];

           if ($ethnic) {

               $ethnic_array = json_decode($ethnic);

               foreach ($ethnic_array as $i => $d) {
                   $array_population[$country.' population'][$i] = $d;
               }

           }


// var_dump($array_population);
    }

    else {


        $sql = "SELECT * FROM data_population WHERE `type` = 'percent' ";

        $q = $pdo->prepare($sql);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);

        while ($r = $q->fetch()) {

            foreach ($r as $i => $d) {
                $array_population[$r['name']][$i] = $d;
            }
        }
        ////  var_dump($array_population);
    }

    $array_pname = array('Jewish (Law of Return)' => 'Jewish');


    $array_population_result = [];


    arsort($data);
    if (is_array($data)) {


        $i = 0;
        $actor_content = '';
        $actor_heder = '';
        $actor_result = '';
        foreach ($data as $name => $summ) {

            $actor_heder .= '<th>' . $name . '</th>';
            $actor_result .= '<td>' . $summ . '%</td>';

           /// echo $name.'-'.$summ.'<br>';

            foreach ($array_population as $p_name => $p_data) {

                foreach ($p_data as $p_data_name => $p_data_val) {

                    if ($p_data_name == $name || $array_pname[$p_data_name] == $name) {

                        $p_data_val = str_replace('%', '', $p_data_val);
                        $presult = $summ - $p_data_val;

                        $array_population_result[$p_name]['value'][$name][0] = $p_data_val;
                        $array_population_result[$p_name]['value'][$name][1] = $presult;

                    }
                }

                if ((!$array_population[$name] && $summ ) && !$array_population_result[$p_name]['value'][$name][1] )
                {
                    $array_population_result[$p_name]['value'][$name][1] = $summ;
                }

            }




            $i++;

        }
        $result_compare = '';

///var_dump($array_population_result);

        foreach ($array_population_result as $p_name => $p_data_val_main) {

            $res_dt = '';
            $res_dtpercent = '';
            foreach ($data as $name => $summ) {
            //foreach ($p_data_val['value'] as $p_data_name => $p_data_val) {


                $p_data_val=$p_data_val_main['value'][$name];

                if (!$p_data_val[0]) {

                    $p_data_val[0] = 0;
                }


                $res_dt .= '<td>' . $p_data_val[0] . ' %</td>';


                $cur_prcnt = $p_data_val[1];


                    if ($cur_prcnt < 0) {
                        $cur_prcnt = '<span class="red">' . $cur_prcnt . '</span>';
                    }
                    else if ($cur_prcnt > 0) {
                        $cur_prcnt = '<span class="green">+' . $cur_prcnt . '</span>';
                    }
                    else {
                        $cur_prcnt = '<span class="green">' . $cur_prcnt . '</span>';
                    }


                $res_dtpercent .= '<td>' . $cur_prcnt . '</td>';

            }

            $result_compare .= '<tr class="actor_data"><td>Percent: ' . $p_name . '</td>' . $res_dt . '</tr>';
            $result_compare .= '<tr class="actor_data"><td>' . $p_name . ' Representation</td>' . $res_dtpercent . '</tr>';

        }


        $actor_content = '<table  class="tablesorter-blackice no_overflow">
<tr><th>Demographic</th>' . $actor_heder . '</tr>
<tr class="actor_data"><td>Percent in movie</td>' . $actor_result . '</tr>
' . $result_compare . '
</table>';


    }

    return $actor_content;
}

function get_country($Details)
{
    $reg = '#Country\:([^\;]+)#';
    if (preg_match($reg, $Details, $mach)) {


        return trim($mach[1]);
    }
}

function get_normal_date($Details, $Year)
{
    $reg = '#([0-9]{1,2} [a-zA-z]+ [0-9]{4})#';

    if (preg_match($reg, $Details, $mach)) {
        return strtotime($mach[1]);
    }

    return strtotime('01.01.' . $Year);

}

function wph_cut_by_words($maxlen, $text)
{
    $len = (mb_strlen($text) > $maxlen) ? mb_strripos(mb_substr($text, 0, $maxlen), ' ') : $maxlen;
    $cutStr = mb_substr($text, 0, $len);
    $temp = (mb_strlen($text) > $maxlen) ? $cutStr : $cutStr;
    return $temp;
}

function checkcast($Leading, $actor_array_name)
{
    $result = '';
    $array_result = [];
    $e = 0;
    foreach ($actor_array_name as $id => $name) {
        if (strstr($Leading, $name)) {
            $array_result[] = $id;
            $e = 1;
        }
    }
    if ($e) {

        $result = $array_result;
    }
    return $result;
}

function check_ethnic_array($v1, $v2)
{
    if (strstr(strtolower(trim($v1)), strtolower(trim($v2)))) {
        return 0;
    }
    return 1;
}

function get_movie_data_from_db($id, $a_sql = '', $only_etnic = 0)
{
    $i = $i0 = $i_j = 0;
    $need_request = '';

    global $pdo;
    $actor_data = [];
    if (!$a_sql) {

        /////check cache


        //////////////////check enable ethnic cache


        $sql2 = "SELECT ethnicdata FROM `data_movie_ethnic` WHERE  movie_id = '" . $id . "'  limit 1";

        //// echo $sql.'<br>';

        $q = $pdo->prepare($sql2);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);


        $r2 = $q->fetch();

        if ($r2['ethnicdata']) {


            $result = json_decode($r2['ethnicdata'], JSON_FORCE_OBJECT);

            $enable_ethnic_cache = 1;

            if ($only_etnic) {

                return $result;
            } else {


                $sql2 = "SELECT actor_data FROM `data_movie_actor_cache` WHERE  movie_id = '" . $id . "'  limit 1";
                $q = $pdo->prepare($sql2);
                $q->execute();
                $q->setFetchMode(PDO::FETCH_ASSOC);
                $r2 = $q->fetch();
                if ($r2['actor_data']) {

                    $actors = json_decode($r2['actor_data'], JSON_FORCE_OBJECT);


                    $result['actors'] = $actors;


                    return $result;
                }

            }


        }


        //////////////////check enable ethnic cache


///echo 'cont';
        /////get movie actors
        $sql = "SELECT * FROM data_actors WHERE data_actors.MovieID = " . $id . " ";

        $q = $pdo->prepare($sql);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);


        $ar_sort = ['star' => 1, 'main' => 2, 'extra' => 3];
        $actor_array_name = [];
        $actor_array = [];
        $i = $i_etnic = $i_j = 0;

        while ($r = $q->fetch()) {
            $actors[$ar_sort[$r['Category']]][$r['actor_id']] = $r;

            $a_sql .= "OR actor_id =" . $r['actor_id'] . " ";

            $actor_array[] = $r['actor_id'];
            $actor_array_name[$r['actor_id']] = $r['Name'];

            $actor_data['groop'][$r['actor_id']] = $r['Category'];

        }

        if ($a_sql) {
            $a_sql = substr($a_sql, 2);
        }


//add actors to cache
        if ($only_etnic == 0) {

            add_actor_to_movie_cache($id, 0, $actors);
        }


        if ($enable_ethnic_cache) {

            $result['actors'] = $actors;


            return $result;
        }

    }


    /////////ethnic//////////


    $sql = "SELECT Ethnicity as ethnicity, Tags, actor_id   FROM `data_actors_ethnic` WHERE   " . $a_sql;

    $q = $pdo->prepare($sql);
    $q->execute();
    $q->setFetchMode(PDO::FETCH_ASSOC);


    global $array_exclude;

    while ($r = $q->fetch()) {

        if ($r['ethnicity']) {
            $ethnicity = $r['ethnicity'];
            if (strstr($ethnicity, 'Ashkenazi')) {
                $ethnicity = 'Ashkenazi Jewish';
                //$Ethnicity_vrct = 'Jew';
            } elseif (strstr($ethnicity, 'Jew')) {
                $ethnicity = 'Jew';
                //$Ethnicity_vrct = 'Jew';
            } else {
                ///  echo $r['actor_id'].' <br>';

                $tags_array = [];
                $tags_array_string = $r['Tags'];

                ///  echo 'tags_array_string='.$tags_array_string.'<br>';

                ///  echo 'ethnicity='.$ethnicity.'<br>';

                $tags_array_string = strtolower($tags_array_string);
                if (strstr($tags_array_string, ',')) {
                    $tags_array = explode(',', $tags_array_string);
                } else {
                    $tags_array[] = $tags_array_string;
                }


                $get_array = 0;

                $regv = '#([A-Za-z ]{4,})#';
                if (preg_match_all($regv, $ethnicity, $mach)) {
                    foreach ($mach[1] as $word) {
                        ///    echo  $word.'<br>';
                        $get_array = 0;
                        $next = 0;

                        foreach ($array_exclude as $exstring) {
                            if (strstr(strtolower(trim($word)), strtolower(trim($exstring)))) {
                                $next = 1;
                            }
                        }
                        foreach ($tags_array as $tags) {

                            if (strstr(strtolower(trim($word)), strtolower(trim($tags))) && !$next) {
                                $ethnicity = $tags;
                                $get_array = 1;
                                break;
                            }

                        }

                        if ($get_array == 1) {
                            break;
                        }


                    }

                }

                ///  echo '<br>ethnicity_result='. $ethnicity.'<br>';


                if (!$get_array && $tags_array[0] && $ethnicity != 'NA') {
                    foreach ($tags_array as $data) {
                        $next = 0;
                        foreach ($array_exclude as $exstring) {
                            if (strstr(strtolower(trim($data)), strtolower(trim($exstring)))) {
                                $next = 1;
                            }

                        }


                        if (!$next && !is_numeric(trim($data))) {
                            $ethnicity = $data;
                            break;
                        }
                    }
                }

                if (strstr($ethnicity, ',')) {
                    $ethnicity_array = explode(',', $ethnicity);
                    $ethnicity = $ethnicity_array[0];
                }

                if (in_array(ucfirst(trim($ethnicity)), $array_exclude)) {
                    $ethnicity = 'N/A';
                }


                if ($ethnicity == 'NA') {
                    $ethnicity = 'N/A';
                }

            }


            if ($ethnicity) {

                // echo $ethnicity.'<br>';
                $ethnicity = ucfirst(trim($ethnicity));

                ///   echo $ethnicity.'<br>';
                $actor_data['ethnic'][$r['actor_id']][$ethnicity] = 100;
                $i_etnic++;
            }

        }


    }

////////////////// jew or not jew

    $sql = "SELECT Verdict, actor_id FROM `data_actors_jew` WHERE " . $a_sql;
    $q = $pdo->prepare($sql);
    $q->execute();
    $q->setFetchMode(PDO::FETCH_ASSOC);

    while ($r = $q->fetch()) {

        $verdict = 'N/A';
        if ($r['Verdict']) {
            $verdict = $r['Verdict'];
        }

        $actor_data['jew'][$r['actor_id']][$verdict] = 100;

        $i_j++;

    }


    ////////////////// face

    $sql = "SELECT * FROM `data_actors_face` WHERE " . $a_sql;
    $q = $pdo->prepare($sql);
    $q->execute();
    $q->setFetchMode(PDO::FETCH_ASSOC);

    while ($r = $q->fetch()) {
        $actor_data['face2'][$r['actor_id']][ucfirst($r['race'])] = $r['percent'] * 100;
    }


///////////////////////////race
    $sql = "SELECT *  FROM data_actors_race where " . $a_sql;

    $q = $pdo->prepare($sql);
    $q->execute();
    $q->setFetchMode(PDO::FETCH_ASSOC);


    while ($r = $q->fetch()) {

        $actor_data['surname'][$r['actor_id']]['EA'] += (float)$r['EastAsian'] * 100;
        $actor_data['surname'][$r['actor_id']]['EA'] += (float)$r['Japanese'] * 100;

        $actor_data['surname'][$r['actor_id']]['I'] = (float)$r['Indian'] * 100;
        $actor_data['surname'][$r['actor_id']]['M'] = (float)$r['Muslim'] * 100;
        $actor_data['surname'][$r['actor_id']]['B'] = (float)$r['Africans'] * 100;

        $actor_data['surname'][$r['actor_id']]['W'] += (float)$r['British'] * 100;
        $actor_data['surname'][$r['actor_id']]['W'] += (float)$r['EastEuropean'] * 100;
        $actor_data['surname'][$r['actor_id']]['W'] += (float)$r['French'] * 100;
        $actor_data['surname'][$r['actor_id']]['W'] += (float)$r['Germanic'] * 100;
        $actor_data['surname'][$r['actor_id']]['W'] += (float)$r['Italian'] * 100;
        $actor_data['surname'][$r['actor_id']]['W'] += (float)$r['Nordic'] * 100;


        $actor_data['surname'][$r['actor_id']]['JW'] = (float)$r['Jewish'] * 100;
        $actor_data['surname'][$r['actor_id']]['H'] = (float)$r['Hispanics'] * 100;


        arsort($actor_data['surname'][$r['actor_id']]);
        /// var_dump($actor_data['surname'][$r['actor_id']]);

        $key = array_keys($actor_data['surname'][$r['actor_id']]);
        $value = $actor_data['surname'][$r['actor_id']][$key[0]];
        unset($actor_data['surname'][$r['actor_id']]);
        ///  echo '<br>';
        $actor_data['surname'][$r['actor_id']][$key[0]] = round($value, 0);
        /// var_dump($actor_data['surname'][$r['actor_id']]);
        //   echo '<br>name_____________________________<br>';


        $actor_data['face'][$r['actor_id']]['A'] = (float)$r['Asian'] * 100;
        $actor_data['face'][$r['actor_id']]['B'] = (float)$r['Black'] * 100;
        $actor_data['face'][$r['actor_id']]['H'] = (float)$r['Hispanic'] * 100;
        $actor_data['face'][$r['actor_id']]['W'] = (float)$r['White'] * 100;
        $actor_data['face'][$r['actor_id']]['O'] = 100 - ((float)$r['Asian'] * 100 + (float)$r['Black'] * 100 + (float)$r['Hispanic'] * 100 + (float)$r['White'] * 100);

        ///   echo '<br>';
        arsort($actor_data['face'][$r['actor_id']]);
        //  var_dump($actor_data['face'][$r['actor_id']]);

        $key = array_keys($actor_data['face'][$r['actor_id']]);
        $value = $actor_data['face'][$r['actor_id']][$key[0]];
        unset($actor_data['face'][$r['actor_id']]);
        /// echo '<br>';
        $actor_data['face'][$r['actor_id']][$key[0]] = round($value, 0);
        ///  var_dump($actor_data['face'][$r['actor_id']]);
        ///  echo '<br>face _____________________________<br>';


        $i++;


    }

    ///////////////////////////gender
    ///
    $sql = "SELECT Gender, actor_id FROM data_actors_gender  where " . $a_sql;

    $q = $pdo->prepare($sql);
    $q->execute();
    $q->setFetchMode(PDO::FETCH_ASSOC);

    $array_convert = array('Male' => 'm', 'Female' => 'f', 'NA' => 'n');

    while ($r = $q->fetch()) {
        $actor_data['gender'][$r['actor_id']][$array_convert[$r['Gender']]] = 1;
    }


    ///////box office
    $box = 0;


    $sql = "SELECT * FROM  data_movie_rank WHERE MovieID=" . $id . " limit 1";


    $q = $pdo->prepare($sql);
    $q->execute();
    $q->setFetchMode(PDO::FETCH_ASSOC);


    $r = $q->fetch();

    if ($r['Box Office Worldwide']) {
        $box = $r['Box Office Worldwide'];
    } else if ($r['Box Office International'] && $r['Box Office Domestic']) {
        $box = $r['Box Office International'] + $r['Box Office Domestic'];
    } else {
        $box = $r['Box Office Domestic'];
    }

    $title = $r['Title'];
    $Production = $r['Production Method'];

    $Leading = $r['Leading Cast'];
    $Supporting = $r['Supporting Cast'];
    $Rest = $r['Rest of Cast'];

    $leading_data = checkcast($Leading, $actor_array_name, 'leading');
    $Supporting_data = checkcast($Supporting, $actor_array_name, 'Supporting');
    $Rest_data = checkcast($Rest, $actor_array_name, 'Rest');
    $cast_num = [];

    $movie_cast_num = 0;

    if ($leading_data || $Supporting_data || $Rest_data) {
        $cast_num = array('leading' => $leading_data, 'Supporting' => $Supporting_data, 'Rest' => $Rest_data);
        $movie_cast_num = 1;
    }

    ///  var_dump($cast_num);


    $movies_budget = 0;

    $sql = "SELECT Production_Budget  FROM `data_movie_budget`  where MovieID=" . $id;
    $q = $pdo->prepare($sql);
    $q->execute();

    $r = $q->fetch();

    $movies_budget = $r['Production_Budget'];


    //////////movie date

    $movies_date = [];

    $sql = "SELECT `Details`,`FullDetails`,  `Year` FROM data_movie  where MovieID=" . $id;

    $q = $pdo->prepare($sql);
    $q->execute();
    $q->setFetchMode(PDO::FETCH_ASSOC);


    $r = $q->fetch();
    $year = $r['Year'];
    $movies_date = get_normal_date($r['Details'], $r['Year']);
    ////  echo date('d.m.Y',$movies_date);

    $movies_country = get_country($r['FullDetails']);
////echo '$movies_country='.$movies_country;
    $a_result = array(
        'actor_data' => $actor_data, 'movies_date' => $movies_date, 'box' => $box, 'title' => $title, 'Production' => $Production, 'movies_country' => $movies_country,
        'i_j' => $i_j, 'i_ethnic' => $i_etnic, 'i' => $i, 'actors_array' => $actor_array, 'cast_num' => $cast_num);


    $a_result_string = json_encode($a_result, JSON_FORCE_OBJECT);

    data_movie_ethnic_cache($year, $a_result_string, $id, $movies_country, $movie_cast_num, $movies_budget);

    $a_result['actors'] = $actors;


    return $a_result;
}

function data_movie_ethnic_cache($year, $a_result_string, $id, $movies_country, $movie_cast_num, $movies_budget)

{
    global $pdo;


    $sql2 = "SELECT ethnicdata FROM `data_movie_ethnic` WHERE  movie_id = '" . $id . "' limit 1";
    $q = $pdo->prepare($sql2);
    $q->execute();
    $q->setFetchMode(PDO::FETCH_ASSOC);
    $r2 = $q->fetch();
    if (!$r2['ethnicdata']) {

        $sql = "INSERT INTO `data_movie_ethnic` VALUES (NULL, '" . $id . "', '" . $year . "',:data,'" . $movies_country . "','" . $movies_budget . "','" . $movie_cast_num . "','" . time() . "')";
        /// echo $sql;
        $q = $pdo->prepare($sql);
        $q->bindParam(':data', $a_result_string);
        $q->execute();
    }


}


function add_actor_to_movie_cache($id, $cat_string, $actors)
{
    global $pdo;

    $sql2 = "SELECT id FROM `data_movie_actor_cache` WHERE  movie_id = '" . $id . "'  limit 1";
    $q = $pdo->prepare($sql2);
    $q->execute();
    $q->setFetchMode(PDO::FETCH_ASSOC);
    $r2 = $q->fetch();
    if (!$r2['id']) {
        $a_result_string = json_encode($actors, JSON_FORCE_OBJECT);

        $sql = "INSERT INTO `data_movie_actor_cache` VALUES (NULL, '" . $id . "', '" . $cat_string . "',:data,'" . time() . "')";
        $q = $pdo->prepare($sql);
        $q->bindParam(':data', $a_result_string);
        $q->execute();
    }


}

function set_data_from_movie($movie_id, $actor_type)
{
    global $pdo;


    ////////////get_all_actors

    foreach ($actor_type as $actor_type_enable) {
        if ($actor_type_enable) {
            if ($actor_type_enable != 'all') {

                $dop_actors = "and `data_actors`.Category  = '" . $actor_type_enable . "' ";


            }

            $sql = "SELECT actor_id FROM `data_actors`,`data_movie` where `data_actors`.MovieID  = `data_movie`.MovieID
 and `data_movie`.MovieID = '" . $movie_id . "' " . $dop_actors . " limit 10";

            ///    echo $sql . '<br>';

            $q = $pdo->prepare($sql);
            $q->execute();
            $q->setFetchMode(PDO::FETCH_ASSOC);

            if ($q->fetchColumn()) {

                while ($r = $q->fetch()) {
                    /// echo 'actor_id=' . $r['actor_id'] . '<br>';

                    /////get ethnic data from actors


                }
            }


        }
    }


}

function get_data_etn($movie_id, $actor_type)
{
    global $pdo;

    $array_movie_result = get_movie_data_from_db($movie_id, '', 1);

    return $array_movie_result;
}

function add_to_array($input, $output, $i)
{
    $other = 100;

    foreach ($input as $key => $val) {

        $rv = ($val / $i) * 100;
        $rv = round($rv, 2);
        $output  [$key] += $rv;
        $other -= $rv;

    }
    if ($other != 100) {
        $output  ['Other'] = $other;
    }
    return $output;

}

function normalise_array($array)
{
    $totalsumm = 0;


    foreach ($array as $index => $val) {
        $totalsumm += $val;
    }
    if ($totalsumm) {
        foreach ($array as $index => $val) {

            $array_result[$index] = round($val * 100 / $totalsumm, 2);


        }

        return $array_result;


    }
    return $array;
}


function get_echnic($array_years, $ethnycity, $actor_type = array('star', 'main', 'extra'), $limit = 0, $movie_id = '', $default_request = 1)
{

    global $animation;

    global $diversity_select;
    $totalactor = 0;
    /// echo '$diversity_select=' .$diversity_select;


    $arrayneed_compare = [];
    $arrayneed_jew = array('Jew', 'Borderline Jew', 'Not a Jew', 'Barely a Jew',
        'Sadly, not a Jew');//,'N/A');
    $compare_array_exclude = array("Not a Jew", "Sadly, not a Jew", "N/A", "Na");
    $arrayneed_etn = [];

    global $array_convert_k;
    global $array_convert_kf;
    global $array_compare;

    $actors_ethnicity_all = [];
    $actors_jew_all = [];
    $actors_kf_all = [];
    $actors_k_all = [];
    $array_movie_result_all = [];
    $individual_array = [];
    $individual_index = [];
    $compare_array_individual = [];
    $compare_array = [];

    /*
        foreach ($ethnycity as $order => $data) {
            foreach ($data as $type => $enable) {
                if ($enable && $type == 'surname') {


                  ///  unset($array_compare['Other']);


                }
            }
        }
     */

    if ($movie_id) {

        // echo 'default request for single movie ' . $movie_id . '<br>';

        $array_years[1][$movie_id] = get_data_etn($movie_id, $actor_type);

        /// var_dump($array_years[1][$movie_id] );
    }

    foreach ($array_years as $year => $val) {


        $m_count = 0;
        $totalactor_year = 0;
        $totalactor_year_selected = 0;


        $all_actors = [];
        $all_data = [];


        foreach ($val as $movie_id => $movie_data) {
            if ($movie_id) {
                $m_count++;
                ///echo 'MovieID='.$r['MovieID'].'<br>';


                $array_movie_result = $movie_data; /////get_data_etn($r['MovieID'], $actor_type);

                ///  var_dump($array_movie_result);


                //// $all_actors = $array_movie_result['actors_array'];
                foreach ($array_movie_result['actors_array'] as $actor) {
                    $totalactor++;
                    $totalactor_year++;

                    if (in_array($array_movie_result['actor_data']['groop'][$actor], $actor_type)) {


                        if (!in_array($actor, $all_actors)) {
                            $all_actors[] = $actor;
                            $totalactor_year_selected++;
                        }

                    }

                }


                foreach ($array_movie_result['actor_data']['gender'] as $actor => $data) {

                    if (in_array($array_movie_result['actor_data']['groop'][$actor], $actor_type)) {
                        $all_data['gender'][$actor] = $data;
                    }

                }


                foreach ($array_movie_result['actor_data']['surname'] as $actor => $data) {
                    if (in_array($array_movie_result['actor_data']['groop'][$actor], $actor_type)) {
                        $all_data['surname'][$actor] = $data;
                    }
                }
                foreach ($array_movie_result['actor_data']['face'] as $actor => $data) {
                    if (in_array($array_movie_result['actor_data']['groop'][$actor], $actor_type)) {
                        $all_data['face'][$actor] = $data;
                    }
                }
                foreach ($array_movie_result['actor_data']['face2'] as $actor => $data) {
                    if (in_array($array_movie_result['actor_data']['groop'][$actor], $actor_type)) {
                        $all_data['face2'][$actor] = $data;
                    }
                }
                foreach ($array_movie_result['actor_data']['jew'] as $actor => $data) {
                    if (in_array($array_movie_result['actor_data']['groop'][$actor], $actor_type)) {
                        $all_data['jew'][$actor] = $data;
                    }
                }
                foreach ($array_movie_result['actor_data']['ethnic'] as $actor => $data) {
                    if (in_array($array_movie_result['actor_data']['groop'][$actor], $actor_type)) {
                        $all_data['ethnic'][$actor] = $data;
                    }
                }


            }
        }

        ///echo $year . ' count movies ' .$m_count.' total actors: '.$totalactor_year.' selected:'.$totalactor_year_selected.'<br>';

        if (is_array($all_actors)) {
            foreach ($all_actors as $actor_id) {

                //////classification by type
                $multy_enty = 2;

                // if ($diversity_select == 'wj_nw' || $diversity_select == 'w_j_nwj' || $diversity_select == 'wmj_nwm' || $diversity_select == 'wm_j_nwmj') {
                //     $multy_enty = 1;
                // }

                if ($diversity_select == 'm_f') {
                    $array_convert = array('m' => 'Male', 'f' => 'Female', 'n' => 'NA');

                    foreach ($all_data['gender'][$actor_id] as $type => $count) {
                        if ($type && $type != 'n') {

                            $type = $array_convert[$type];

                            if (!$count) $count = 0;
                            $arrayneed_compare[$year][$type] += $count;

                            if (!in_array($type, $arrayneed_compare)) {
                                $arrayneed_compare[] = $type;
                            }
                            $compare_array[$year][$type] += 1;// $count;
                        }
                    }

                } else {

                    $actor_result = 0;

                    foreach ($ethnycity as $order => $data) {

                        if ($actor_result) {
                            break;
                        }
                        foreach ($data as $typeb => $enable) {
                            if ($actor_result) {
                                break;
                            }

                            if ($enable) {


                                if ($all_data[$typeb][$actor_id]) {


                                    arsort($all_data[$typeb][$actor_id]);

                                    foreach ($all_data[$typeb][$actor_id] as $type => $count) {
                                        if ($typeb == 'face' && $type == 'O') {

                                            break;
                                        }

                                        if ($array_compare[$type]) {
                                            $type = $array_compare[$type];
                                        }


                                        if ($diversity_select == 'wmj_nwm' || $diversity_select == 'wm_j_nwmj') {


                                            if ($all_data['gender'][$actor_id]['m'] && $type == 'White') {

                                                ///     continue;
                                                $type = 'White Male';
                                            } else if ($type == 'Jewish') {
                                                $type = 'minusJewish';
                                            } else {
                                                $type = 'non-White';
                                            }

                                        }

                                        if ($type) {

                                            //////////White Male (+ Jews ) v.s. non-White Males

                                            if (!$count) $count = 0;

                                            ////      $individual_array[$year][$type] += $count;
                                            if (!in_array($type, $compare_array_exclude)) {

                                                if (!in_array($type, $arrayneed_compare)) {
                                                    $arrayneed_compare[] = $type;
                                                }
                                                $actor_result = 1;
                                                $compare_array[$year][$type] += 1;// $count;

                                            }
                                            /*
                                                                                     // $compare_index = $type;

                                                                                     /// $last_data = $compare_array_individual[$year][$actor_id][$compare_index];

                                                                                    //  if (!$last_data && $count && $compare_index) {

                                                                                   ///   $compare_array_individual[$year][$actor_id][$type] = $count;
                                                                                       //   $compare_array[$year][$type]+= $count;

                                                                                    //  }

                                                                                      /*

                                                                                                                         else if (!$last_data && $count && !$compare_index) {

                                                                                                                             if (!in_array($type, $arrayneed_compare) && !in_array($type, $compare_array_exclude)) {
                                                                                                                                 $arrayneed_compare[] = $type;

                                                                                                                                 $compare_array[$year][$type] += $count;


                                                                                                                             }

                                                                                                                         }
                                                                             /*

                                                                                                                         if (!in_array($type, $individual_index)) {
                                                                                                                             $individual_index[] = $type;
                                                                                                                         }
                                                                             */
                                        }

                                        break;
                                    }

                                }
                            }
                        }
                    }
                }


            }

        }

    }
    /// echo 'total actor: ' . $totalactor . '<br>';

///var_dump($arrayneed_compare);
///var_dump($compare_array);

    $result = '';
    $array_total_result = '';


/// echo '$multy_enty='.$multy_enty;


    $result_array_compare = [];


    if ($multy_enty > 1) {


        if (is_array($compare_array)) {
            foreach ($compare_array as $year => $data) {


                if ($diversity_select == 'wj_nw') {
                    //////White (+ Jews ) v.s. non-White


                    $data_result = [];

                    foreach ($data as $type => $count) {
                        if ($type == 'White' || $type == 'Jewish') {
                            $data_result['White (+ Jews )'] += $count;

                        } else {
                            $data_result['non-White'] += $count;
                        }

                    }


                    $data = $data_result;
                    $arrayneed_compare = array('White (+ Jews )', 'non-White');

                } else if ($diversity_select == 'wmj_nwm') {
                    //////White Male (+ Jews ) v.s. non-Whites ( + Female Whites )


                    $data_result = [];

                    foreach ($data as $type => $count) {
                        if ($type == 'White Male' || $type == 'minusJewish') {
                            $data_result['White Male (+ Jews )'] += $count;

                        } else {
                            $data_result['non-Whites ( + Female Whites )'] += $count;
                        }

                    }


                    $data = $data_result;
                    $arrayneed_compare = array('White Male (+ Jews )', 'non-Whites ( + Female Whites )');

                } else if ($diversity_select == 'w_j_nwj') {
                    //////White (- Jews ) v.s. non-White (+ Jews)


                    $data_result = [];

                    foreach ($data as $type => $count) {
                        if ($type == 'White') {

                            $data_result['White (- Jews )'] += $count;

                        } else if ($type == 'Jewish') {
                            $data_result['White (- Jews )'] -= $count;
                        } else {
                            $data_result['non-White (+ Jews)'] += $count;
                        }

                    }

                    if ($data_result['White (- Jews )'] < 0) {
                        $data_result['White (- Jews )'] = 0;
                    }


                    $data = $data_result;
                    $arrayneed_compare = array('White (- Jews )', 'non-White (+ Jews)');

                } else if ($diversity_select == 'wm_j_nwmj') {
                    /////White Male (- Jews ) v.s. non-White Males (+ Jews) ( + Female Whites )


                    $data_result = [];

                    foreach ($data as $type => $count) {
                        if ($type == 'White Male') {

                            $data_result['White Male (- Jews )'] += $count;

                        } else if ($type == 'minusJewish') {
                            $data_result['White Male (- Jews )'] -= $count;
                        } else {
                            $data_result['non-Whites ( + Jews + Female Whites )'] += $count;
                        }

                    }

                    if ($data_result['White Male (- Jews )'] < 0) {
                        $data_result['White Male (- Jews )'] = 0;
                    }


                    $data = $data_result;
                    $arrayneed_compare = array('White Male (- Jews )', 'non-Whites ( + Jews + Female Whites )');

                }


                $data = normalise_array($data);


                $array_total_result[$year] = $data;

                $result_inner = "new Date(" . $year . ",1,1)";

                $total_d = 0;
                $total_summ = 0;


                foreach ($arrayneed_compare as $index) {

                    $total = $data[$index];
                    if (!$total) $total = 0;


                    if ($diversity_select == 'diversity') {

                        $total_d += $total * ($total - 1);
                        $total_summ += $total;
                    }


                    $result_inner .= ',' . $total;
                }

                if ($diversity_select == 'diversity') {

                    $total_summ = 1 - ($total_d / ($total_summ * ($total_summ - 1)));

                    $total_summ = round($total_summ, 2);


                    $result .= ",[new Date(" . $year . ",1,1)," . $total_summ . "]";

                    $result_array_compare[$year]['Diversity Index'] = $total_summ;

                } else {

                    $result .= ",[" . $result_inner . "]";
                }
            }
            if ($diversity_select == 'diversity') {
                $arrayneed_compare = array('Simpson’s Diversity Index');
                return array($arrayneed_compare, $result, $result_array_compare);
            }


            return array($arrayneed_compare, $result, $array_total_result);
        }


    }
    /*
    else {


        $result = '';

        if (is_array($individual_array)) {
            foreach ($individual_array as $year => $data) {
                $data = normalise_array($data);

                $result_inner = "new Date(" . $year . ",1,1)";

                $total_d = '';
                $total_summ = '';

                foreach ($individual_index as $index) {

                    $total = $data[$index];
                    if (!$total) $total = 0;

                    $result_inner .= ',' . $total;

                    if ($diversity_select == 'diversity') {

                        $total_d += $total * ($total - 1);
                        $total_summ += $total;
                    }
                }

                if ($diversity_select == 'diversity') {

                    $total_summ = 1 - ($total_d / ($total_summ * ($total_summ - 1)));

                    $total_summ = round($total_summ, 2);


                    $result .= ",[new Date(" . $year . ",1,1)," . $total_summ . "]";

                    $result_array_compare[$year]['Diversity Index'] = $total_summ;
                } else {
                    $result .= ",[" . $result_inner . "]";
                }
            }

        }
        if ($diversity_select == 'diversity') {
            $arrayneed_compare = array('Simpson’s Diversity Index');
            return array($arrayneed_compare, $result, $result_array_compare);
        }

    }
*/
    return array($individual_index, $result, $individual_array);


}


function data_etnic_to_table($resultarray, $diversity_select)
{

    ////get us population
//////Полные тексты	id 	name 	Population Total 	White 	Non-White 	Arab 	Asian 	Black 	Dark Asian 	Indigenous 	Latino 	Mixed / Other 	Jewish (Core) 	Jewish (Law of Return)


    $data = $resultarray[2][1];

    if ($diversity_select != 'diversity') {
        $data = normalise_array($data);
    }
    /// var_dump($diversity_select);


    arsort($data);
    if (is_array($data)) {


        $i = 0;
        $actor_content = '';
        $actor_heder = '';
        $actor_result = '';
        foreach ($data as $name => $summ) {

            if ($i >= 5) {
                break;
            }
            $actor_heder .= '<td>' . $name . '</td>';
            $actor_result .= '<td>' . $summ . '%</td>';


            $i++;

        }


        $actor_content = '<table  class="tablesorter-blackice no_overflow">
<tr>' . $actor_heder . '<td style="width: 30px">More</td></tr>
<tr class="actor_data">' . $actor_result . '<td style="position: relative; overflow: hidden" >
<a id="op" class="open_ethnic open_ul"  href="#"></a></td></tr>
</table>';

        return $actor_content;
    } else {
        return 'no data';
    }


}




if ($_POST['oper'] == 'get_country_data') {

    $id = ($_POST['id']);
    $data = ($_POST['data']);
    $data_object = json_decode($data);
    $cur_year = $_POST['cur_year'];
    $code2 = $_POST['code2'];


    $start = $data_object->start;
    $end = $data_object->end;

    $name = $id;

    global $pdo;

    if ($code2) {


        $sql = "SELECT *  FROM data_population_country where cca2 = ? limit 1";
        $q = $pdo->prepare($sql);
        $q->execute(array(0 => $code2));
        $q->setFetchMode(PDO::FETCH_ASSOC);


    } else {
        $sql = "SELECT *  FROM data_population_country where country_name = ? limit 1";
        $q = $pdo->prepare($sql);
        $q->execute(array(0 => $id));
        $q->setFetchMode(PDO::FETCH_ASSOC);
    }
    $r = $q->fetch();


    $cca2 = $r['cca2'];
    $jew_data = $r['jew_data'];

    $cca3 = $r['cca3'];

    $population_data = $r['population_data'];
    $population_data_result = json_decode($population_data);

    $populatin_by_year = $r['populatin_by_year'];
    $populatin_by_year_result = json_decode($populatin_by_year);


    $populatin_result = [];

    foreach ($population_data_result as $year => $data) {

        if ($end == date('Y', time()) && $year > $end) {

            $populatin_result[$year] = $data;

        }
    }


    foreach ($populatin_by_year_result as $year => $data) {
        if ($data > 0) {

            if ($year >= $start && ($year <= $end)) {
                $populatin_result[$year] = $data;
            }

        }


    }


    if (!$cur_year) {
        if ($populatin_result[$end]) {
            $cur_year = $end;
        } else {

            $cur_year = end(array_keys($populatin_result));

        }
        /// echo $cur_year;
    }


    echo '<h1 style="margin-top: 20px"><span><img style="width: 50px" src="/database/country_data/' . strtolower($cca3) . '.svg"/></span> ' . $r['country_name'] . '</h1>';


    $data_array = $r['ethnic_array_result'];



 echo  '<p style="font-size: 15px;">Ethnic: '.$r['ethnicdata'].'</p>';
    echo   '<a class="source_link" target="_blank" href="https://www.cia.gov/library/publications/the-world-factbook/fields/400.html#'.$cca2.'">Source: https://www.cia.gov</a><br><br>';

 ////////show ethnic
    $ethnic_array=$r['ethnic_array'];
    $actor_heder='';
    $actor_result='';
    $actor_result_year='';
    $actor_race_type='';

    if ($ethnic_array) {
        $array_result = json_decode($ethnic_array);
        $content = '';

        $arry_total = [];

        arsort($array_result);

        $next = 0;
        foreach ($array_result as $index => $val) {

            $index = trim($index);
            $index = strtolower($index);
            $index = ucfirst($index);


            if ($array_compare[$index]) {
                $race = $array_compare[$index];
            }
            else if ($array_compare[$r['country_name']]) {
                $race = $array_compare[$r['country_name']];

            }


            $actor_heder .= '<th>' . $index . '</th>';
            $actor_race_type .= '<td>' .$race. '</td>';
            $actor_result .= '<td>' .$val. '%</td>';
            $actor_result_year .= '<td>' .number_format($val*$populatin_result[$cur_year]/100). '</td>';


        }




            $actor_content_race ='<table  class="tablesorter-blackice no_overflow">
<tr><th>Ethnic compare</th>' . $actor_heder . '</tr>
<tr class="actor_data"><td>Result</td>' . $actor_race_type . '</tr>
<tr class="actor_data"><td>Percent</td>' . $actor_result . '</tr>
<tr class="actor_data"><td>Total population by year ('.$cur_year.')</td>' . $actor_result_year . '</tr>
</table><br>';



            echo $actor_content_race;

    }






    if ($jew_data)
    {
        $data =json_decode($jew_data) ;
        $actor_heder='';
        $actor_result='';
        $actor_result_year='';

        foreach ($data as $name => $jew_count) {

            if ($jew_count>0) {
                if ($populatin_result)
                {

                    $population=$populatin_result[2018];

                    if ($population && $jew_count)
                    {
                        $jew_percent = ($jew_count/$population)*100;
                        $jew_percent = round($jew_percent,4);
                    }

                }


            }




            $actor_heder .= '<th>' . $name . '</th>';
            $actor_result .= '<td>' .$jew_percent. '%</td>';
            $actor_result_year .= '<td>' .number_format($jew_percent*$populatin_result[$cur_year]/100). '</td>';
        }


        $actor_content_jew= '<table  class="tablesorter-blackice no_overflow">
<tr><th>Jew population</th>' . $actor_heder . '</tr>
<tr class="actor_data"><td>Percent</td>' . $actor_result . '</tr>
<tr class="actor_data"><td>Total population by year ('.$cur_year.')</td>' . $actor_result_year . '</tr>
</table><br>';



     echo $actor_content_jew;
     echo   '<a class="source_link" target="_blank" href="https://en.wikipedia.org/wiki/Jewish_population_by_country">Source: https://en.wikipedia.org/wiki/Jewish_population_by_country</a><br><br>';

 }




    if ($data_array) {

        $actor_heder='';
        $actor_result='';
        $actor_result_year='';

        $data = json_decode($data_array);

        foreach ($data as $name => $summ) {

            $actor_heder .= '<th>' . $name . '</th>';
            $actor_result .= '<td>' . $summ . '%</td>';
            $actor_result_year .= '<td>' . number_format($summ * $populatin_result[$cur_year] / 100) . '</td>';
        }



        $actor_content = '<table  class="tablesorter-blackice no_overflow">
<tr><th>Result ethnic data</th>' . $actor_heder . '</tr>
<tr class="actor_data"><td>Percent</td>' . $actor_result . '</tr>
<tr class="actor_data"><td>Total population by year (' . $cur_year . ')</td>' . $actor_result_year . '</tr>
</table>';
        echo $actor_content.'<br><br>';


    }



  //  var_dump($populatin_result);

    ksort($populatin_result);


    foreach ($populatin_result as $year => $summ) {

        $summ = round($summ, 0);
        $result_in .= "{ x: " . $year . ", y: " . $summ . " },";

    }

    $result_data .= "{
                  name: '" . $r['country_name'] . " population',
                    type: 'spline',
                   ///color: '" . $array_ethnic_color[$name] . "', 
                    marker: {            enabled: false        },
                  turboThreshold:0,
                  data: [" . $result_in . "]},";

////////graph

    ?>
    <div id="country_div_<?php echo  $r['id'] ?>" style="width: 100%; height: 400px"></div>
<br>
<?php
echo   '<a class="source_link" target="_blank" href="https://worldpopulationreview.com/">Source: https://worldpopulationreview.com</a><br>
        <a class="source_link" target="_blank" href="https://datatopics.worldbank.org/world-development-indicators/themes/people.html">Source: https://datatopics.worldbank.org</a><br><br>';

?>




    <script type="text/javascript">

        Highcharts.chart('country_div_<?php echo  $r['id'] ?>', {
            chart: {
                zoomType: 'xy',
            },
            title: {
                text: '<?php echo $r['country_name'] ?> population'
            },

            xAxis: {
                title: {
                    text: 'Year',

                },
            },
            yAxis: {
                title: {
                    text: 'Total',

                },
            },
            legend: {
                enabled: false
            },

            plotOptions: {
                series: {
                    cursor: 'pointer',
                },

            },


            series: [<?php echo $result_data; ?>]
        });

    </script>

    <?php


}
if ($_POST['oper'] === 'get_movie_cast_data_main') {

    $id = intval($_POST['id']);
    $data = ($_POST['data']);
    $data_object = json_decode($data);

///var_dump($data_object);


    global $animation;
    global $diversity_select;

    $start = $data_object->start;


    $end = $data_object->end;
    $IMDb = $data_object->IMDb;

    $animation = $data_object->animation;
    $inflation = $data_object->inflation;
    $country = $data_object->country;

    $data_type = $data_object->data_type;
    $ethnycity = $data_object->ethnycity;

    $actor_type = $data_object->actor_type;
    $limit = $data_object->movies_limit;
    $diversity_select = $data_object->diversity_select;
    $display_select = $data_object->display_select;


    if (!$actor_type) {
        $actor_type = array('star', 'main', 'extra');
    }


    $resultarray = get_echnic('', $ethnycity, $actor_type, $limit, $id);


    $actor_content = data_etnic_to_table($resultarray, $diversity_select);

    echo $actor_content;


    /// var_dump($data);

}
else if ($_POST['oper'] === 'get_actordata') {

    global $array_convert_k;
    global $array_convert_kf;

    $id = intval($_POST['id']);

    $data = ($_POST['data']);
    $data_object = json_decode($data);
    $ethnycity = $data_object->ethnycity;


    $w = '';
    $cat = array('star', 'main', 'extra');

////////get actor data

    $a_sql = "actor_id ='" . $id . "' ";

    $array_movie_result = get_movie_data_from_db($id, $a_sql);

    $face2 = $array_movie_result['actor_data']['face2'][$id];

    $face = $array_movie_result['actor_data']['face'][$id];
    $surname = $array_movie_result['actor_data']['surname'][$id];
    $etn = $array_movie_result['actor_data']['ethnic'][$id];

///var_dump($ethnycity);

    foreach ($ethnycity as $order => $data) {
        foreach ($data as $type => $enable) {
            if ($enable && $type == 'surname') {
                echo '<p class="in_hdr">Surname Analysis:</p>';
                if ($surname) {

                    $sql = "SELECT *  FROM data_actors_race where " . $a_sql;

                    $q = $pdo->prepare($sql);
                    $q->execute();
                    $q->setFetchMode(PDO::FETCH_ASSOC);

                    $actor_data = [];

                    while ($r = $q->fetch()) {

                        $actor_data['EA'] += (float)$r['EastAsian'] * 100;
                        $actor_data['EA'] += (float)$r['Japanese'] * 100;

                        $actor_data['I'] = (float)$r['Indian'] * 100;
                        $actor_data['M'] = (float)$r['Muslim'] * 100;
                        $actor_data['B'] = (float)$r['Africans'] * 100;

                        $actor_data['W'] += (float)$r['British'] * 100;
                        $actor_data['W'] += (float)$r['EastEuropean'] * 100;
                        $actor_data['W'] += (float)$r['French'] * 100;
                        $actor_data['W'] += (float)$r['Germanic'] * 100;
                        $actor_data['W'] += (float)$r['Italian'] * 100;
                        $actor_data['W'] += (float)$r['Nordic'] * 100;

                        $actor_data['JW'] = (float)$r['Jewish'] * 100;
                        $actor_data['H'] = (float)$r['Hispanics'] * 100;
                    }

                    $actor_data = normalise_array($actor_data);

                    arsort($actor_data);

                    echo '<div class="small_desc">';
                    foreach ($actor_data as $i => $v) {
                        echo $array_compare[$i] . ': ' . $v . '%<br>';
                    }
                    echo '</div>';

                    $key = array_keys($surname);


                    echo '<p class="verdict">Verdict: ' . $array_compare[$key[0]] . '</p>';
                    echo '<a class="source_link" style="font-size: 11px" target="_blank" href="https://pypi.org/project/ethnicolr/">Source: https://pypi.org/project/ethnicolr/</a>';

                } else echo '<p class="verdict">N/A</p>';


            }
            if ($enable && $type == 'jew') {

                echo '<p class="in_hdr">JewOrNotJew:</p>';
                if ($array_movie_result['actor_data']['jew'][$id]) {
                    //////gett_jew_data

                    /*
                    $sql = "SELECT Verdict, actor_id FROM `data_actors_jew` WHERE " . $a_sql;
                    $q = $pdo->prepare($sql);
                    $q->execute();
                    $q->setFetchMode(PDO::FETCH_ASSOC);

                    while ($r = $q->fetch()) {

                        $verdict = 'N/A';
                        if ($r['Verdict']) {
                            $verdict = $r['Verdict'];
                        }

                        $actor_data['jew'][$r['actor_id']][$verdict] = 100;

                        $i_j++;

                    }*/

                    foreach ($array_movie_result['actor_data']['jew'][$id] as $i => $v) {
                        echo '<p class="verdict">Verdict: ' . $i . '</p>';
                    }


                    echo '<a class="source_link" target="_blank" href="http://jewornotjew.com/">Source: http://jewornotjew.com/</a>';

                } else {
                    echo 'N/A<br>';
                }

            }
            if ($enable && $type == 'face') {

                echo '<p class="in_hdr">Facial Recognition by Kairos:</p>';
                if ($face) {


                    $sql = "SELECT *  FROM data_actors_race where " . $a_sql;

                    $q = $pdo->prepare($sql);
                    $q->execute();
                    $q->setFetchMode(PDO::FETCH_ASSOC);

                    $actor_data = [];

                    while ($r = $q->fetch()) {

                        $actor_data['A'] = (float)$r['Asian'] * 100;
                        $actor_data['B'] = (float)$r['Black'] * 100;
                        $actor_data['H'] = (float)$r['Hispanic'] * 100;
                        $actor_data['W'] = (float)$r['White'] * 100;
                        $actor_data['O'] = 100 - ((float)$r['Asian'] * 100 + (float)$r['Black'] * 100 + (float)$r['Hispanic'] * 100 + (float)$r['White'] * 100);

                    }


                    $actor_data = normalise_array($actor_data);
                    arsort($actor_data);
                    echo '<div class="small_desc">';
                    foreach ($actor_data as $i => $v) {
                        echo $array_compare[$i] . ': ' . $v . '%<br>';
                    }
                    echo '</div>';

                    $key = array_keys($face);
                    echo '<p class="verdict">Verdict: ' . $array_compare[$key[0]] . '</p>';

                    echo '<a class="source_link" style="font-size: 11px" target="_blank" href="https://kairos.com/">Source: https://kairos.com/</a>';

                } else   echo 'N/A<br>';
            }
            if ($enable && $type == 'face2') {

                echo '<p class="in_hdr">Facial Recognition by Betaface:</p>';
                if ($face2) {
                    $face2 = normalise_array($face2);
                    arsort($face2);

                    $key = array_keys($face2);
                    echo '<p class="verdict">Verdict: ' . $array_compare[$key[0]] . '</p>';


                    echo '<a class="source_link" target="_blank" href="https://www.betafaceapi.com/demo_old.html">Source: https://www.betafaceapi.com/</a>';

                } else     echo 'N/A<br>';
            }
            if ($enable && $type == 'ethnic') {
                echo '<p class="in_hdr">Ethnicelebs:</p>';

                if ($array_movie_result['actor_data']['ethnic'][$id]) {
                    $sql = "SELECT Ethnicity as ethnicity, Tags, actor_id, Link   FROM `data_actors_ethnic` WHERE   " . $a_sql . " limit 1";

                    $q = $pdo->prepare($sql);
                    $q->execute();
                    $q->setFetchMode(PDO::FETCH_ASSOC);

                    while ($r = $q->fetch()) {

                        if ($r['ethnicity']) {

                            echo '<div class="small_desc">';
                            echo $r['ethnicity'] . '<br>';
                            echo '</div>';

                        }
                    }
                    $key = array_keys($etn);
                    $ethnic_result = ucfirst($key[0]);
                    if ($array_compare[$ethnic_result]) {
                        echo '<p class="verdict">Verdict: ' . $array_compare[$ethnic_result] . '</p>';
                    } else {
                        echo '<p class="verdict">Verdict: ' . $ethnic_result . '</p>';
                    }

                    if ($r['Link']) {

                        echo '<a class="source_link" style="font-size: 11px" target="_blank" href="' . $r['Link'] . '">Source: ' . $r['Link'] . '</a>';
                    } else {
                        echo '<a class="source_link" style="font-size: 11px" target="_blank" href="http://ethnicelebs.com/">Source: http://ethnicelebs.com/</a>';
                    }

                } else {
                    echo 'N/A<br>';

                }
            }
        }
    }


    echo '<br>';


} else if ($_POST['oper'] === 'movie_data') {

    $id = intval($_POST['id']);
    $global_actor_id = '';

    // $inflation = intval($_POST['inflation']);

    $cat = $_POST['cat'];
    $w = '';

    if (!$cat) {
        $cat = array('star', 'main', 'extra');
    }


    $i = $i0 = 0;

    /////////////get total data

    $data = ($_POST['data']);

    $data_object = json_decode($data);

///var_dump($data_object);


    global $animation;
    global $diversity_select;

    $start = $data_object->start;


    $end = $data_object->end;
    $IMDb = $data_object->IMDb;

    $animation = $data_object->animation;
    $inflation = $data_object->inflation;
    $country = $data_object->country;

    $data_type = $data_object->data_type;
    $ethnycity = $data_object->ethnycity;

    $actor_type = $data_object->actor_type;
    $limit = $data_object->movies_limit;
    $diversity_select = $data_object->diversity_select;
    $display_select = $data_object->display_select;

    if (!$actor_type) {
        $actor_type = array('star', 'main', 'extra');
    }


    $resultarray = get_echnic('', $ethnycity, $actor_type, $limit, $id);
    $data = $resultarray[2][1];
    $data = normalise_array($data);


    $actor_type_string = implode(', ', $actor_type);
    $actor_content_type = '<h2 style="margin-top: 20px">Cast (' . $actor_type_string . ')</h2>';


    ///get movie link

    $actor_content = set_table_ethnic($data);


    if ($id) {


        ////////production budget
        $sql = "SELECT Production_Budget  FROM `data_movie_budget`  where MovieID=" . $id;
        $q = $pdo->prepare($sql);
        $q->execute();

        $r = $q->fetch();

        $movies_budget = $r['Production_Budget'];


        $sql = "SELECT `Details`,`FullDetails`,  `Year` FROM data_movie  where MovieID=" . $id;

        $q = $pdo->prepare($sql);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);


        $r = $q->fetch();
        $year = $r['Year'];
        $movies_date = get_normal_date($r['Details'], $r['Year']);
        ////  echo date('d.m.Y',$movies_date);

        $movies_country = get_country($r['FullDetails']);

        $sql = "Select Link, Title FROM `data_movie_rank` where MovieID=" . $id . " limit 1";

    }
    /// echo $sql.'<br>';

    $q = $pdo->prepare($sql);
    $q->execute();
    $q->setFetchMode(PDO::FETCH_ASSOC);


    $r = $q->fetch();
    ///  var_dump($r);
    if ($r['Link']) {

        echo '<h1>' . $r['Title'] . '</h1><p class="small">Country: ' . $movies_country . '</p>';

        if ($movies_budget) {

            echo '<p class="small">Movie budget: $ ' . number_format($movies_budget) . '</p>';
        }
        echo '<a class="source_link" target="_blank" href="' . $r['Link'] . '">Source: ' . $r['Link'] . '</a>';
    }


    echo $actor_content_type . $actor_content;


////////////////
    $array_movie_result = get_movie_data_from_db($id, '');

///var_dump($array_movie_result);

    //////////create result_data
    global $array_convert_k;
    global $array_convert_kf;

    $actors = $array_movie_result['actors'];


    $i_ethnic = $array_movie_result['i_ethnic'];
    $i_j = $array_movie_result['i_j'];
    $i = $array_movie_result['i'];

    $actors_k = [];

    global $array_compare;

    foreach ($array_movie_result['actor_data']['surname'] as $actor => $data) {


        if (in_array($array_movie_result['actor_data']['groop'][$actor], $actor_type)) {

            foreach ($data as $index => $val) {

                $actors_k[$array_compare[$index]] += $val;

            }
        }

    }

    foreach ($array_movie_result['actor_data']['face'] as $actor => $data) {
        if (in_array($array_movie_result['actor_data']['groop'][$actor], $actor_type)) {
            foreach ($data as $index => $val) {
                $actors_kf[$array_compare[$index]] += $val;
            }
        }
    }


    foreach ($array_movie_result['actor_data']['face2'] as $actor => $data) {
        if (in_array($array_movie_result['actor_data']['groop'][$actor], $actor_type)) {
            foreach ($data as $index => $val) {
                $actors_kf2[$array_compare[$index]] += $val;
            }
        }
    }


    foreach ($array_movie_result['actor_data']['jew'] as $actor => $data) {
        if (in_array($array_movie_result['actor_data']['groop'][$actor], $actor_type)) {
            foreach ($data as $index => $val) {
                $actors_jew[$index] += $val;
            }
        }

    }


    foreach ($array_movie_result['actor_data']['ethnic'] as $actor => $data) {
        if (in_array($array_movie_result['actor_data']['groop'][$actor], $actor_type)) {
            foreach ($data as $index => $val) {
                $actors_ethnicity[$array_compare[ucfirst($index)]] += $val;
            }
        }

    }


    arsort($actors_kf2);
    arsort($actors_kf);
    arsort($actors_k);
    arsort($actors_jew);
    arsort($actors_ethnicity);


    $actors_kf2 = normalise_array($actors_kf2);
    $actors_kf = normalise_array($actors_kf);
    $actors_k = normalise_array($actors_k);
    $actors_jew = normalise_array($actors_jew);
    $actors_ethnicity = normalise_array($actors_ethnicity);

    /*
     * create charts
     */
    // surname_analysis
    $a_kf = 0;

    ///  var_dump($actors_k);


    foreach ($actors_k as $index => $val) {
        $rv = ($val);
        $rv = round($rv, 2);

        $ra_s .= "['" . $index . "'," . $rv . "],";
        $a_kf++;
        if ($a_kf > 9) break;
    }

    // facial_recognition
    $other = 100;


    foreach ($actors_kf as $index => $val) {
        $rv = ($val);
        $rv = round($rv, 2);

        /// $other -= $rv;

        $rs .= "['" . $index . "'," . $rv . "],";

    }

    foreach ($actors_kf2 as $index => $val) {
        $rv = ($val);
        $rv = round($rv, 2);

        /// $other -= $rv;

        $rs2 .= "['" . $index . "'," . $rv . "],";

    }
    ///$rs .= "['Other'," . $other . "],";

    $a_kf2 = 0;


    foreach ($actors_jew as $index => $val) {
        $rv = ($val);
        $rv = round($rv, 2);

        $ra_jew .= "['" . $index . "'," . $rv . "],";
        $a_kf2++;
    }


    $a_kf3 = 0;

    foreach ($actors_ethnicity as $index => $val) {
        $rv = ($val);
        $rv = round($rv, 2);

        $ra_ethnicity .= "['" . $index . "'," . $rv . "],";
        $a_kf2++;
    }


    ?>
    <div
        <?php if (!$global_actor_id){ ?>style="display: grid; grid-template-columns: 1fr 1fr; grid-gap: 25px;margin-top: 20px;"<?php } ?>>


        <?php


        $surname = '';
        $jew = '';
        $face = '';
        $face2 = '';
        $ethnic = '';


        foreach ($ethnycity as $order => $data) {
            foreach ($data as $type => $enable) {
                if ($enable && $type == 'surname') {

                    $surname = 1;
                    ?>
                    <div class="gr_cont_in">
                        <div id="surname_analysis<?php echo $global_actor_id; ?>"></div>
                        <a class="source_link" target="_blank" href="https://pypi.org/project/ethnicolr/">Source:
                            https://pypi.org/project/ethnicolr/</a>
                    </div>


                    <?php

                    $surtext = '&sur=1';


                }
                if ($enable && $type == 'jew') {
                    $jew = 1;
                    ?>
                    <div class="gr_cont_in">
                        <div id="jewornotjew<?php echo $global_actor_id; ?>"></div>
                        <a class="source_link" target="_blank" href="http://jewornotjew.com/">Source:
                            http://jewornotjew.com/</a>
                    </div>
                    <?php

                    $jewtext = '&jew=1';

                }
                if ($enable && $type == 'face') {
                    $face = 1;
                    ?>
                    <div class="gr_cont_in">
                        <div id="facial_recognition<?php echo $global_actor_id; ?>"></div>
                        <a class="source_link" target="_blank" href="https://kairos.com/">Source:
                            https://kairos.com/</a>
                    </div>
                    <?php

                    $facetext = '&face=1';

                }
                if ($enable && $type == 'face2') {
                    $face2 = 1;
                    ?>
                    <div class="gr_cont_in">
                        <div id="facial_recognition_b_<?php echo $global_actor_id; ?>"></div>
                        <a class="source_link" target="_blank" href="https://www.betafaceapi.com/demo_old.html">Source:
                            https://www.betafaceapi.com/</a>
                    </div>
                    <?php

                    $face2text = '&face2=1';

                }
                if ($enable && $type == 'ethnic') {
                    $ethnic = 1;
                    ?>
                    <div class="gr_cont_in">
                        <div id="ethnicelebs<?php echo $global_actor_id; ?>"></div>
                        <a class="source_link" target="_blank" href="http://ethnicelebs.com/">Source:
                            http://ethnicelebs.com/</a>
                    </div>
                    <?php
                    $ethnictext = '&eth=1';

                }
            }
        }

        ?>

    </div>

    <script type="text/javascript">
        $(document).ready(function () {
            google.charts.load('current', {packages: ['corechart', 'bar']});

            <?php if ($rs && $face){ ?>

            google.charts.setOnLoadCallback(drawBasic);

            <?php } if ($ra_s && $surname){ ?>
            google.charts.setOnLoadCallback(drawBasic2);
            <?php } if ($ra_jew && $jew){ ?>
            google.charts.setOnLoadCallback(drawBasic3);
            <?php } if ($ra_ethnicity && $ethnic){ ?>
            google.charts.setOnLoadCallback(drawBasic4);
            <?php }
            if ($rs2 && $face2){ ?>
            google.charts.setOnLoadCallback(drawBasic5);
            <?php }
            ?>

            function drawBasic5() {
                var data = google.visualization.arrayToDataTable([
                    ['Data', 'Result %',],
                    <?php echo $rs2; ?>
                ]);
                var options = {
                    title: 'Facial Recognition by Betaface:',
                    vAxis: {
                        format: 'Short',
                        textColor: '#d5d5d5',
                    },
                    hAxis: {
                        textColor: '#d5d5d5',
                        title: 'Total %',
                        titleTextStyle: {
                            color: '#d5d5d5'
                        },
                        minValue: 0
                    },
                    legend: {
                        position: 'none'
                    },
                    height: 300,
                    backgroundColor: '#282828',
                    titleTextStyle: {
                        color: '#d5d5d5',
                        fontSize: 19,
                    },
                    colors: ['#50a553'],
                };
                var chart = new google.visualization.BarChart(document.getElementById('facial_recognition_b_<?php echo $global_actor_id; ?>'));
                chart.draw(data, options);
            }

            function drawBasic() {
                var data = google.visualization.arrayToDataTable([
                    ['Data', 'Result %',],
                    <?php echo $rs; ?>
                ]);
                var options = {
                    title: 'Facial Recognition by Kairos:',
                    vAxis: {
                        format: 'Short',
                        textColor: '#d5d5d5',
                    },
                    hAxis: {
                        textColor: '#d5d5d5',
                        title: 'Total %',
                        titleTextStyle: {
                            color: '#d5d5d5'
                        },
                        minValue: 0
                    },
                    legend: {
                        position: 'none'
                    },
                    height: 300,
                    backgroundColor: '#282828',
                    titleTextStyle: {
                        color: '#d5d5d5',
                        fontSize: 19,
                    },
                    colors: ['#50a553'],
                };
                var chart = new google.visualization.BarChart(document.getElementById('facial_recognition<?php echo $global_actor_id; ?>'));
                chart.draw(data, options);
            }

            function drawBasic2() {
                var data = google.visualization.arrayToDataTable([
                    ['Data', 'Result %',],
                    <?php echo $ra_s; ?>
                ]);
                var options = {
                    title: 'Surname Analysis:',
                    vAxis: {
                        format: 'Short',
                        textColor: '#d5d5d5',
                    },
                    hAxis: {
                        textColor: '#d5d5d5',
                        title: 'Total %',
                        titleTextStyle: {
                            color: '#d5d5d5'
                        },
                        minValue: 0
                    },
                    legend: {
                        position: 'none'
                    },
                    titleTextStyle: {
                        color: '#d5d5d5',
                        fontSize: 19,
                    },
                    height: 300,
                    backgroundColor: '#282828',
                    colors: ['#50a553'],
                };
                var chart = new google.visualization.BarChart(document.getElementById('surname_analysis<?php echo $global_actor_id; ?>'));
                chart.draw(data, options);
            }

            function drawBasic3() {
                var data = google.visualization.arrayToDataTable([
                    ['Data', 'Result %',],
                    <?php echo $ra_jew; ?>
                ]);
                var options = {
                    title: 'JewOrNotJew:',
                    vAxis: {
                        format: 'Short',
                        textColor: '#d5d5d5',
                    },
                    hAxis: {
                        textColor: '#d5d5d5',
                        title: 'Total %',
                        titleTextStyle: {
                            color: '#d5d5d5'
                        },
                        minValue: 0
                    },
                    legend: {
                        position: 'none'
                    },
                    titleTextStyle: {
                        color: '#d5d5d5',
                        fontSize: 19,
                    },
                    height: 300,
                    backgroundColor: '#282828',
                    colors: ['#50a553'],
                };
                var chart = new google.visualization.BarChart(document.getElementById('jewornotjew<?php echo $global_actor_id; ?>'));
                chart.draw(data, options);
            }

            function drawBasic4() {
                var data = google.visualization.arrayToDataTable([
                    ['Data', 'Result %',],
                    <?php echo $ra_ethnicity; ?>
                ]);
                var options = {
                    title: 'Ethnicelebs:',
                    vAxis: {
                        format: 'Short',
                        textColor: '#d5d5d5',
                    },
                    hAxis: {
                        textColor: '#d5d5d5',
                        title: 'Total %',
                        titleTextStyle: {
                            color: '#d5d5d5'
                        },
                        minValue: 0
                    },
                    legend: {
                        position: 'none'
                    },
                    titleTextStyle: {
                        color: '#d5d5d5',
                        fontSize: 19,
                    },
                    height: 300,
                    backgroundColor: '#282828',
                    colors: ['#50a553'],
                };
                var chart = new google.visualization.BarChart(document.getElementById('ethnicelebs<?php echo $global_actor_id; ?>'));
                chart.draw(data, options);
            }
        });
    </script>
    <?php
    // var_dump($actors_k);


    $cat_array = array(1 => 'star', 2 => 'main', 3 => 'extra');

    if (!$global_actor_id) {
        if (is_array($actors)) {
            ksort($actors);

            foreach ($actors as $index => $data) {

                if (in_array($cat_array[$index], $cat)) {


                    $actor_cntr = '';


                    foreach ($data as $id => $val) {
                        if ($id) {
                            $img = '<div class="img_tooltip"><img  src="https://' . $_SERVER['HTTP_HOST'] . '/database/create_image.php?id=' . $id . $ethnictext . $face2text . $facetext . $jewtext . $surtext . '" /></div>';
                            $actor_cntr .= '<div class="a_data"><a id="op" class="actor_info open_ul" data-id="' . $id . '"  href="#"></a>
                    <div class="a_data_r">' . $val['Role'] . '</div>
                    <div class="a_data_n">' . $val['Name'] . ' </div>
                    <div class="a_data_more" style="display: none"></div>
                    <div class="a_data_v">' . $img . '</div>
                    </div>';
                        }
                    }

                    if ($index == 1) {
                        $content .= '<h2>Stars</h2><div class="star_actors">' . $actor_cntr . '</div>';
                    }
                    if ($index == 2) {
                        $content .= '<h2>Main actors</h2><div class="main_actors">' . $actor_cntr . '</div>';
                    }
                    if ($index == 3) {
                        $content .= '<h2>Extra actors</h2><div class="extra_actors">' . $actor_cntr . '</div>';
                    }


                }
            }
        }

    }
    echo $content;
    return;
}
if ($_POST['oper'] === 'get_inner' || $_POST['oper'] === 'get_chart_by_country' || $_POST['oper'] === 'get_race_data')
{


    $data = $_POST['data'];

    if ($_POST['oper'] === 'get_chart_by_country') {
        $post_country = $_POST['id'];
        echo '<h2>' . $post_country . '</h2>';
    } else {
        $date = $_POST['colum_data'];
        $year = intval($date);
    }

    $data_object = json_decode($data);

//var_dump($data_object);

    $start = $data_object->start;
    $end = $data_object->end;


    $IMDb = $data_object->IMDb;

    $animation = $data_object->animation;
    $inflation = $data_object->inflation;
    $country = $data_object->country;

    $data_type = $data_object->data_type;
    $ethnycity = $data_object->ethnycity;

    $actor_type = $data_object->actor_type;
    $limit = $data_object->movies_limit;
    $diversity_select = $data_object->diversity_select;
    $display_select = $data_object->display_select;
    $country_movie_select = $data_object->country_movie_select;
    $budget_min = $data_object->budget_min;
    $budget_max = $data_object->budget_max;
    $DomesticBox = 1;
    $International = 1;
    $byCountry = 1;
    $cast = 1;


    if ($_POST['oper'] === 'get_race_data') {

        $year = intval($_POST['id']);
        $race = $_POST['race'];

        $array_country = [];
        $array_total = [];
        $array_country_data = [];
        $ethnic_array_result = [];
        $ethnic_array = [];

        $sql = "SELECT *  FROM `data_population_country`";

///echo $sql;
        $array_total_summ=[];

        $q = $pdo->prepare($sql);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);

        $array = [];
        $total_row = 0;
        while ($r = $q->fetch())
        {


                $country = $r['country_name'];

           ///     echo $country.' <br>';

                $population_data = $r['population_data'];
                $population_data_result = json_decode($population_data, JSON_FORCE_OBJECT);

                $populatin_by_year = $r['populatin_by_year'];
                $populatin_by_year_result = json_decode($populatin_by_year, JSON_FORCE_OBJECT);

                $ethnic_array_result = $r['ethnic_array_result'];

                if ($ethnic_array_result) {
                    $ethnic_array_result = json_decode($ethnic_array_result, JSON_FORCE_OBJECT);
                }

                $summ = 0;

                $data = $population_data_result[$year];

                if ($year > date('Y', time())) {
                    $summ = $data;
                }

                $data = $populatin_by_year_result[$year];

                if ($data > 0) {
                    $summ = $data;

                }

                $array_total_summ['world']+=$summ;

               /// echo $country.' '.$summ.' <br>';


                $count = $ethnic_array_result[$race];

                if ($count > 0) {

                    $summ_result = $count * $summ / 100;
                    $array_total[$country] += $summ;

                    foreach ($ethnic_array_result as $i => $v) {

                        $ethnic_array[$i] += $count * $v / 100;

                    }

                    $array_country_data[$country] = array('ethnic' => $ethnic_array_result);


                }



        }


        arsort($array_total);


        $id = 0;

        arsort($ethnic_array);
        ///  var_dump($ethnic_array);



        foreach ($array_total as $country => $summ) {
            $id++;

            ///echo $country.' '.$summ.'<br>';

            $cnt = '';

            if (is_array($ethnic_array_result)) {

                foreach ($ethnic_array as $e => $enable) {

                    $percent=$array_country_data[$country]['ethnic'][$e];
                    if (!$percent)$percent=0;

                    if ($e==$race) {
                     $cnt .= '<td>' . $percent . '</td><td>' . number_format(round($percent * $summ)/100 ). '</td>';
                     $array_total_summ[$e]+=round($percent * $summ)/100;
                    }
                }
            }

            ///  print_r($array_country_data[$country]['ethnic']);

            if ($summ) {

                $content .= '<tr id="' . $country . '" class="click_open"><td>' . $id . '</td><td>' . $country . '</td><td>' . number_format(round($summ)) . '</td>' . $cnt . '<td style="position: relative; overflow: hidden"><a id="op" class="open_country_data open_ul" href="#"></a></td></tr>';
            }
        }

        $colspan = 4;

        foreach ($ethnic_array as $e => $enable) {

            if ($e==$race) {
                $hdr .= '<th>' . $e . ' %</th><th>' . $e . ' total</th>';
                $colspan += 2;
            }
        }

        $footer_inner='';
        foreach ($array_total_summ as $e => $summ) {

            $summ=round($summ);

            $world = $array_total_summ['world'];

            $percent= round( ($summ/$world)*100,2);

          ////  echo $summ.' '. $world.' '.($summ/$world).'<br>';

            $footer_inner.='<td>'.$percent.'</td><td>'.number_format($summ).'</td>';
        }

        echo '<h1>'.$race.' (year: <span class="cur_year">'.$year.'</span>)</h1>';

        echo '<table  class="tablesorter tablesorter-blackice no_overflow"><thead><tr><th>№</th><th>Country</th><th>Population</th>' . $hdr . '<th style="width: 30px">More</th>';

        $footer='<tr><td></td>'.$footer_inner.'<td></td></tr>';
    }
    else {


        $inflation_array = array();


        if ($inflation) {

            if ($year) {
                $sql = "SELECT * FROM `data_inflation` where Year ='" . $year . "'";
            } else {
                $sql = "SELECT * FROM `data_inflation`";
            }

            $q = $pdo->prepare($sql);
            $q->execute();
            $q->setFetchMode(PDO::FETCH_ASSOC);

            $array_years = [];

            while ($r = $q->fetch()) {
                $inflation_array[$r['Year']] = $r['value'];
            }
        }

        if ($IMDb) {
            $idop = " and data_movie_rank.MovieID  > 0 ";
        }
        if ($animation == 1) {
            $idop .= " and data_movie_rank.`Production Method` NOT LIKE '%Animat%' ";
        } else if ($animation == 2) {
            $idop .= " and data_movie_rank.`Production Method` = 'Live Action' ";
        }

        $idopcnt = '';


        if ($country_movie_select) {
            foreach ($country_movie_select as $cntry_m) {
                $idopcnt .= " OR data_movie_ethnic.`movie_country` LIKE '" . $cntry_m . "%' ";


            }
            $idopcnt = substr($idopcnt, 3);

            $idopcnt = " and (" . $idopcnt . ")";

            $idop .= $idopcnt;

            $join_dop = ' INNER join data_movie_ethnic on (data_movie_ethnic.movie_id = data_movie_rank.MovieID)';
        }

        if ($post_country) {
            $array_compare_country = array('UK' => 'United Kingdom');

            if ($array_compare_country[$post_country]) {
                $post_country_2 = $array_compare_country[$post_country];
            } else {
                $post_country_2 = $post_country;
            }

            if (!$country_movie_select) {
                $join_dop = ' INNER join data_movie_ethnic on (data_movie_ethnic.movie_id = data_movie_rank.MovieID)';
            }

            $idop .= " and (data_movie_ethnic.`movie_country` LIKE '" . $post_country . "%' OR data_movie_rank.Countries LIKE '%" . $post_country_2 . "%'  )";


        }


        if ($budget_min || $budget_max) {


            $join_dop .= " INNER join data_movie_budget  on (data_movie_budget.MovieID =  data_movie_rank.MovieID ) ";


            if ($budget_min || $budget_max) {
                if ($budget_min) {
                    $idop .= " and data_movie_budget.`Production_Budget`>=" . intval($budget_min) . " ";
                }
                if ($budget_max) {
                    $idop .= " and data_movie_budget.`Production_Budget`<=" . intval($budget_max) . " ";
                }
            }

        }
        if ($year) {
            $year_request = "data_movie_rank.`Year` = " . $year . "   and ";
            echo '<h1>' . $year . '</h1>';
        }


        echo '<div class="table_ethnic_total"></div>';

        if ($start) {
            $idop .= " and data_movie_rank.`Year` >= " . $start;
        }

        if ($end) {
            $idop .= " and data_movie_rank.`Year` <= " . $end;
        }

        if (!$date && $start && $end) {
            $date = $start . ' - ' . $end;
        }

        $sql = "SELECT data_movie_rank.* FROM data_movie_rank " . $join_dop . " where " . $year_request . "    
    (data_movie_rank.`Box Office Domestic` > 0 OR data_movie_rank.`Box Office International` > 0 OR  data_movie_rank.`Box Office Country` > 0) " . $idop;

///echo $sql;

        $q = $pdo->prepare($sql);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);

        $array = [];
        $total_row = 0;
        while ($r = $q->fetch()) {


            if (!$year) {
                $year = $r['Year'];


            }


            $totalbox = $r['Box Office Worldwide'];

            if ($totalbox == 0) {
                $totalbox = $r['Box Office Domestic'];
            }
            if ($totalbox != 0) {
                $k = $inflation_array[$year];
                if (!$k) $k = 1;

                $totalbox = $totalbox * $k;

                $all_totalbox += $totalbox;

                if ($DomesticBox) {
                    $array[$totalbox][$r['id']]['d'] = $r['Box Office Domestic'] * $k;

                    $all_DomesticBox += $r['Box Office Domestic'] * $k;
                }
                if ($International) {
                    $array[$totalbox][$r['id']]['i'] = $r['Box Office International'] * $k;
                    $all_International += $r['Box Office International'] * $k;
                }


                if ($byCountry) {

                    if ($r['Box Office Country']) {
                        $array_country = json_decode($r['Box Office Country']);
                        ///   var_dump($array_country);
                        foreach ($array_country as $country => $summ) {


                            if ($summ > 0) {
                                $array[$totalbox][$r['id']]['c'][$country] = $summ * $k;
                                $array[$totalbox][$r['id']]['c_all'] += $summ * $k;
                            }


                        }

                    }

                }


                $array[$totalbox][$r['id']]['t'] = $r['Title'];
                $array[$totalbox][$r['id']]['im'] = $r['MovieID'];
                $array[$totalbox][$r['id']]['yr'] = $r['Year'];

            }

            $total_row++;
        }

        krsort($array);

        if (is_array($array)) {
            $i = 0;
            foreach ($array as $w => $val) {
                if ($w != 0) {
                    $i++;
                    foreach ($val as $id => $data) {
                        $share = ($data['d'] / $w) * 100;
                        $share = round($share, 2);
                        //print_r($data['gender']);
                        $content .= '<tr class="click_open" id="' . $data['im'] . '"><td>' . $i . '</td><td>' . $data['t'] . '<br><span class="gray">' . $data['yr'] . '</span></td><td>$ ' . number_format($w) . '</td>';

                        if ($DomesticBox) {
                            $content .= '<td>$ ' . number_format($data['d']) . '</td>';
                        }
                        if ($International) {
                            $content .= '<td>$ ' . number_format($data['i']) . '</td>';
                        }

                        if ($DomesticBox && $International) {
                            $content .= '<td>' . $share . '</td>';
                        }

                        if ($byCountry) {


                            if (is_array($data['c'])) {
                                /////sort country by summ

                                arsort($data['c']);


                                $ix = 0;
                                $counry_content = '';
                                $country_heder = '<td>Total</td>';
                                $country_result = '<td>' . number_format($data['c_all']) . '</td>';
                                foreach ($data['c'] as $country_name => $summ) {

                                    if ($ix >= 5 && !$post_country) {
                                        break;
                                    }

                                    if (($post_country && $country_name == $post_country_2) || !$post_country) {
                                        $country_heder .= '<td>' . $country_name . '</td>';
                                        $country_result .= '<td>' . number_format($summ) . '</td>';
                                    }

                                    $ix++;
                                }
                                $counry_content = '<table  class="tablesorter-blackice no_overflow">
<tr>' . $country_heder . '<td style="width: 30px">More</td></tr>
<tr class="country_data">' . $country_result . '<td style="position: relative; overflow: hidden" ><a id="op" class="open_country open_ul"  href="#"></a><div style="display: none" class="data">' . json_encode($data['c']) . '</div></td></tr>
</table>';


                                $content .= '<td >' . $counry_content . '</td>';
                            } else {
                                $content .= '<td></td>';
                            }


                        }
                        if ($cast) {
                            if ($data['cast']) {


                                $content .= '<td class="movie_cast_data">' . $data['cast'] . '</td>';

                            } else {

                                $content .= '<td  class="movie_cast_data" ></td>';
                            }

                        }


                        $content .= '</tr>';
                    }
                }
            }
        }


        ////////////result data


        $all_share = $all_DomesticBox / $all_totalbox * 100;
        $all_share = round($all_share, 2);


        echo '<table class="tablesorter-blackice"><tr><th>Year</th><th>Worldwide Box Office</th><th>Domestic Box Office</th><th>International Box Office</th><th>Domestic Share %</th></tr>
<tr><td>' . $date . '</td><td>$ ' . number_format($all_totalbox) . '</td><td>$ ' . number_format($all_DomesticBox) . '</td><td>$ ' . number_format($all_International) . '</td><td>' . $all_share . '</td></tr></table>';


        echo '<!-- pager -->
    <div class="pager">
        <span class="pagedisplay"></span>
    </div>
    <table id="get_inner_table" cellspacing="0" class="tablesorter">
    <thead><tr><th>#</th><th>Movie</th><th>Worldwide Box Office</th>';
        $colspan = 3;
        if ($DomesticBox) {
            $colspan += 1;
            echo '<th>Domestic Box Office</th>';
        }
        if ($International) {
            $colspan += 1;
            echo '<th>International Box Office</th>';
        }

        if ($DomesticBox && $International) {
            $colspan += 1;
            echo '<th>Domestic Share %</th>';
        }

        if ($byCountry) {
            $colspan += 1;
            echo '<th>Box Office by Country</th>';
        }


        if ($cast) {
            $colspan += 1;
            echo '<th>Cast</th>';
        }
    }

    echo '</tr></thead>
    <tbody>' . $content . '</tbody>
    <tfoot>' . $footer . '
        <tr>
          <td colspan="' . $colspan . '">
            <div class="pager"> <span class="left">
                # per page:
                <a href="#">10</a> |
                <a href="#" class="current">25</a> |
                <a href="#">50</a> |
                <a href="#">100</a>
            </span>
            <span class="right">
                <span class="prev">
                    <img src="/database/tablesorter/addons/pager/icons/prev.png" /> Prev&nbsp;
                </span>
                <span class="pagecount"></span>
                &nbsp;<span class="next">Next
                    <img src="/database/tablesorter/addons/pager/icons/next.png" />
                </span>
            </span>
            </div>
          </td>
        </tr>
      </tfoot>
    </table>
    <script id="js">$(function(){
        var $table = $(\'table.tablesorter\'),
            $pager = $(\'.pager\');
    
        $.tablesorter.customPagerControls({
            table          : $table,                   // point at correct table (string or jQuery object)
            pager          : $pager,                   // pager wrapper (string or jQuery object)
            pageSize       : \'.left a\',                // container for page sizes
            currentPage    : \'.right a\',               // container for page selectors
            ends           : 2,                        // number of pages to show of either end
            aroundCurrent  : 1,                        // number of pages surrounding the current page
            link           : \'<a href="#">{page}</a>\', // page element; use {page} to include the page number
            currentClass   : \'current\',                // current page class name
            adjacentSpacer : \'<span> | </span>\',       // spacer for page numbers next to each other
            distanceSpacer : \'<span> &#133; <span>\',   // spacer for page numbers away from each other (ellipsis = &amp;#133;)
            addKeyboard    : true,                     // use left,right,up,down,pageUp,pageDown,home, or end to change current page
            pageKeyStep    : 10                        // page step to use for pageUp and pageDown
        });
    
        // initialize tablesorter & pager
        $table
            .tablesorter({
                theme: \'blackice\',
                widgets: [\'zebra\', \'columns\'/*, \'filter\'*/],
           
            }).bind(\'pagerChange\', function(e, c) {
    ajax_cast_data_main=0;     ';


if ($_POST['oper'] != 'get_race_data') {

 echo 'get_ajax_cast();';

}
echo '    })
    
    .tablesorterPager({
                // target the pager markup - see the HTML block below
                container: $pager,
                size: 25,
                page: 0,
                savePages : false,
                pageReset: 0,
                output: \'showing: {startRow} to {endRow} ({filteredRows})\'
            });
    });
    </script>';
    return;
}

// actor info
if ($_POST['oper'] === 'actor_info') {
    $actor_id = (int)$_POST['actor_id'];

    $sql = "SELECT *, (SELECT Verdict FROM `data_actors_jew` WHERE `actor_id` = data_actors_race.actor_id LIMIT 1) as verdict FROM data_actors_race where actor_id = '" . $actor_id . "' LIMIT 1";
    $q = $pdo->prepare($sql);
    $q->execute();
    $q->setFetchMode(PDO::FETCH_ASSOC);

    echo '';
    return;
}


$type = 'box';

$start = 1970;
$end = 2018;

if ($_POST['oper'] === 'box' || $_POST['oper'] === 'get_movie_cast_data_total') {


    $type = 'box';
    $data = $_POST['data'];
    $data_object = json_decode($data);

//var_dump($data_object);

    global $animation;
    global $diversity_select;

    $start = $data_object->start;
    $end = $data_object->end;
    $IMDb = $data_object->IMDb;
    $animation = $data_object->animation;
    $inflation = $data_object->inflation;
    $country = $data_object->country;

    $data_type = $data_object->data_type;
    $ethnycity = $data_object->ethnycity;

    $actor_type = $data_object->actor_type;
    $limit = $data_object->movies_limit;
    $diversity_select = $data_object->diversity_select;
    $display_select = $data_object->display_select;

    $country_movie_select = $data_object->country_movie_select;

    $budget_min = $data_object->budget_min;
    $budget_max = $data_object->budget_max;

    if ($IMDb) {
        $idop = " and data_movie_rank.MovieID  > 0 ";
    }

    $display_xa_axis = $data_object->display_xa_axis;


    if ($display_select == 'ethnicity') {

        $display_xa_axis = 'Box Office Worldwide';

    }


    if (!$actor_type) {
        $actor_type = array('star', 'main', 'extra');
    }

    $inflation_array = array();

    if ($inflation) {
        $sql = "SELECT * FROM `data_inflation` ";
        $q = $pdo->prepare($sql);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);

        $array_years = [];

        while ($r = $q->fetch()) {
            $inflation_array[$r['Year']] = $r['value'];
        }
    }


    if ($animation == 2) {
        $idop .= " and data_movie_rank.`Production Method` = 'Live Action' ";
    }
    $idopcnt = '';
    if ($country_movie_select) {
        foreach ($country_movie_select as $cntry_m) {
            $idopcnt .= " OR data_movie_ethnic.`movie_country` LIKE '" . $cntry_m . "%' ";


        }
        $idopcnt = substr($idopcnt, 3);

        $idopcnt = " and (" . $idopcnt . ")";

        $idop .= $idopcnt;

        $join_dop = ' INNER join data_movie_ethnic on (data_movie_ethnic.movie_id = data_movie_rank.MovieID)';
    }


    if ($_POST['oper'] === 'get_movie_cast_data_total')
    {


        $type_post = ($_POST['type']);
        if ($type_post == 'years') {
            $yaer = intval($_POST['id']);
            $idopcnt .= " and data_movie_ethnic.`Year` = " . $yaer . " ";
        } else if ($type_post == 'country') {
            $post_country = ($_POST['id']);


            $array_compare_country = array('UK' => 'United Kingdom');

            if ($array_compare_country[$post_country]) {
                $post_country_2 = $array_compare_country[$post_country];
            } else {
                $post_country_2 = $post_country;
            }

            if (!$country_movie_select) {
                $join_dop = ' INNER join data_movie_rank on (data_movie_ethnic.movie_id = data_movie_rank.MovieID)';
            }

            $idopcnt .= " and (data_movie_ethnic.`movie_country` LIKE '" . $post_country . "%' OR data_movie_rank.Countries LIKE '%" . $post_country_2 . "%'  )";


        }
    }

    if ($display_select == 'Buying_power2') {
        $populatin_result = [];
        $result_in = '';
        $array_country_data = [];
        $array_country = [];
        $data_power = [];
        $per_capita_max=0;
        $per_capita_min=10000000000000000000000000;

        $array_code = array('XK' => 'KV');

        $sql = "SELECT *  FROM  data_population_country ";
        ///echo $sql.PHP_EOL;
        $q = $pdo->prepare($sql);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);

        while ($r = $q->fetch()) {


            // $country = $r['country_name'];
            $cca2 = $r['cca2'];



            $sql2 = "SELECT *  FROM `data_buying_power` where cca2='".$r['cca2']."' limit 1";


            $q2 = $pdo->prepare($sql2);
            $q2->execute();
            $q2->setFetchMode(PDO::FETCH_ASSOC);

            $r2 = $q2->fetch();

            //var_dump($r2);

            $country = $r2['name'];


            if ($array_code[$cca2]) {
                $cca2 = $array_code[$cca2];
            }

            $per_capita=0;
            $total=0;
            $date=0;


            $per_capita = $r2['per_capita'];

            if ($per_capita>$per_capita_max)
            {
                $per_capita_max= $per_capita;
            }

            if ($per_capita<$per_capita_min)
            {
                $per_capita_min = $per_capita;
            }


            $total = $r2['total'];
            $date = $r2['date'];

            if (!$date)$date=2010;
            if (!$total)$total=1000;
            if (!$per_capita)$per_capita=1000;


            $data_power[$cca2]=array($country,$per_capita,$total,$date);

        }



///var_dump($data_power);

        $result_data = '';
        $result_in = '';

        foreach ($data_power as $cca2 => $val) {

            if ($cca2 && $val[2] && $val[0] ) {

                //  $result_in .=
                echo "{ name: '" . $val[0] . "', code2: '" . $cca2 . "', value: '" . $val[1] . "', year:'" . $val[3] . "', total:'" . $val[2] . "'},";
                echo '<br>';
            }

        }


        $result_data .= "{  data: [" . $result_in . "],
                       joinBy: ['iso-a2', 'code2'],
                       name: 'Purchasing Power Parity (Per Capita)',
                           dataLabels: {
                          // enabled: true,
                         ///  format: '{point.name}'
   
                       }  ,
              
                
              ///  color: '#ccc',
                
                },";



    }
    if ($display_select == 'Buying_power_by_race') {
        $array_total=[];
        $yearmin=0;

        $yaerstart=2010;

        $sql = "SELECT *  FROM `data_buying_power`, data_population_country where data_buying_power.cca2=data_population_country.cca2";
        ///echo $sql.PHP_EOL;
        $q = $pdo->prepare($sql);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);

        while ($r = $q->fetch()) {

            $country = $r['name'];
            $cca2 = $r['cca2'];
            $per_capita = $r['per_capita'];
            $total = $r['total'];

            $year = $r['date'];
            if ($year>$yearmin)
            {
                $yearmin= $year;
            }

            $populatin_by_year = $r['populatin_by_year'];
            $populatin_by_year_result = json_decode($populatin_by_year, JSON_FORCE_OBJECT);

            $pop = $populatin_by_year_result[$yaerstart];



            $ethnic_array_result = $r['ethnic_array_result'];

            if ($ethnic_array_result && $per_capita) {

                $ethnic_array_result = json_decode($ethnic_array_result, JSON_FORCE_OBJECT);


                foreach ($ethnic_array_result as $e => $count) {

                    $population=($total/$per_capita)*($count/100);

                    /*
                    echo 'race '.$e.'<br>';
                    echo 'count '.$count.'<br>';
                    echo $per_capita.'<br>';
                    echo $total.'<br>';
                    echo 'population '.$population.'<br>';
*/

                    $summ_country = $population*$per_capita;


                   /// echo 'population '.($total/$per_capita)*($count/100).'<br>';
                $array_total['p'][$e]+=$summ_country;
                $array_total['t'][$e]+=$count*$total/100;
                $array_total['i'][$e]+=$population;


                $array_total['pop_p'][$e]+=$count*$pop/100;
                $array_total['pop_all'][$e]+=$pop;

                }

            }

        }
       arsort($array_total['t'] );


foreach ($array_total['t'] as $race=>$count)
{

    $result_in_all.= "{name:'".$race."', y: ".round($count,0).", color: '" . $array_ethnic_color[$race] . "'},";
    $result_in_pop_all.= "{name:'".$race."', y: ".round($array_total['pop_p'][$race],0) .",content:'Population ".$array_total['pop_p'][$race]."'}, ";
}




$array_temp=[];



foreach ($array_total['p'] as $race=>$count)
        {

           $pop =   $array_total['i'][$race];

           $count=$count/$pop;
           $array_temp[$race]=round($count,0);


        }

        arsort($array_temp);

        foreach ($array_temp as $race=>$count)
        {


            $result_in.= "{name:'".$race."', y: ".$count.", color: '" . $array_ethnic_color[$race] . "'}, ";

            $result_in_pop.= "{name:'".$race."', y: ".round($array_total['pop_p'][$race],0) .",content:'Population ".$array_total['pop_p'][$race]."'}, ";

        }
//var_dump($array_total['p']);
    }

  else  if ($display_select == 'Buying_power') {
        $populatin_result = [];
        $result_in = '';
        $result_c='';
        $result_c_all='';
        $array_country_data = [];
        $array_country = [];
        $data_power = [];
        $per_capita_max=0;
        $per_capita_min=10000000000000000000000000;

        $all_data_max=0;
        $all_data_min=10000000000000000000000000;

        $array_code = array('XK' => 'KV');

        $sql = "SELECT *  FROM `data_buying_power`, data_population_country where data_buying_power.cca2=data_population_country.cca2";
        ///echo $sql.PHP_EOL;
        $q = $pdo->prepare($sql);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);

        while ($r = $q->fetch()) {

            $country = $r['name'];
            $cca2 = $r['cca2'];
            $cca3 = strtolower($r['cca3']);

            if ($array_code[$cca2]) {
             $cca2 = $array_code[$cca2];
            }


            $per_capita = $r['per_capita'];

            if ($per_capita>$per_capita_max)
            {
                $per_capita_max= $per_capita;
            }
            if ($per_capita<$per_capita_min)
            {
                $per_capita_min= $per_capita;
            }


            $total = $r['total'];

            if ($total>$all_data_max)
            {
                $all_data_max= $total;
            }
            if ($total<$all_data_min)
            {
                $all_data_min= $total;
            }



            $date = $r['date'];
            $data_power[$cca2]=array($country,$per_capita,$total,$date,$cca3);




        }


        $result_data = '';
        $result_in = '';
        $result_in_all = '';
            foreach ($data_power as $cca2 => $val)

            {


                //$result_c .= "['".$val[0]."',  ".round($val[1],0)."],";
                $result_c .= "{name:'".$val[4]."', y: ".round($val[1],0).", country: '" . $val[0]  . "', code2: '" . $cca2 . "'},";
                $result_c_all .= "{name:'".$val[4]."', y: ".round($val[2],0).", country: '" . $val[0]  . "', code2: '" . $cca2 . "'},";

                $result_in .= "{ name: '" . $val[0] . "', code2: '" . $cca2 . "', value: '" . $val[1] . "', year:'" . $val[3] . "', total:'" . $val[2] . "'},";

                $result_in_all .= "{ name: '" . $val[0] . "', code2: '" . $cca2 . "', value: '" . $val[2] . "', year:'" . $val[3] . "', total:'" . $val[1] . "'},";


            }

            $result_data .= "{  data: [" . $result_in . "],
                       joinBy: ['iso-a2', 'code2'],
                       name: 'Purchasing Power Parity (Per Capita)',
                           dataLabels: {
                          // enabled: true,
                         ///  format: '{point.name}'
   
                       }  ,
              
                
              ///  color: '#ccc',
                
                },";



    }


    else if ($display_select == 'world_map') {
        $populatin_result = [];
        $result_in = '';
        $array_country_data = [];
        $array_country = [];
        $array_race = [];

        $array_code = array('XK' => 'KV');

        $sql = "SELECT *  FROM `data_population_country`";
        ///echo $sql.PHP_EOL;
        $q = $pdo->prepare($sql);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);

        while ($r = $q->fetch()) {

            $country = $r['country_name'];
            $cca3 = $r['cca3'];
            $cca2 = $r['cca2'];


            if ($array_code[$cca2]) {
                $cca2 = $array_code[$cca2];
            }

            ////////////////
            $ethnic_array_result = $r['ethnic_array_result'];
            if ($ethnic_array_result) {
                $ethnic_array_result = json_decode($ethnic_array_result, JSON_FORCE_OBJECT);
                $key = array_keys($ethnic_array_result);
                $value = $key[0];


                $ethnic_country = '';
                foreach ($ethnic_array_result as $race => $count) {


                    $ethnic_country .= $race . ' : ' . $count . '<br>';

                }


            }

            $population_data = $r['population_data'];
            $population_data_result = json_decode($population_data);

            $populatin_by_year = $r['populatin_by_year'];
            $populatin_by_year_result = json_decode($populatin_by_year);

            $populatin_result = [];

            foreach ($population_data_result as $year => $data) {
                if ($year > date('Y', time())) {
                    $populatin_result[$year] = $data;
                }
            }

            foreach ($populatin_by_year_result as $year => $data) {
                if ($data > 0) {
                    $populatin_result[$year] = $data;
                }
            }
            $last_summ = 0;
            $last_year = 0;

            foreach ($populatin_result as $year => $summ) {

                if ($year >= $start && ($year <= $end)) {

                    $last_summ = $summ;
                    $last_year = $year;
                }
            }

            if ($value) {
                // $array_movie_bell[$value][$cca2] = array($country, $ethnic_country, $last_summ, $last_year);
            }

            /////////////////////

                        $ethnic_array = $r['ethnic_array'];
                        $array_result = json_decode($ethnic_array);
                        $content = '';

                        $arry_total = [];

                        arsort($array_result);

                        $next=0;
                        foreach ($array_result as $index => $val) {

                            $index = trim($index);
                            $index = strtolower($index);
                            $index = ucfirst($index);


                            if ($array_compare[$index]) {
                            $race = $array_compare[$index];

                            $arry_total[$race]+= $val;
                            $next=1;
                            }

                            else if ($array_compare[$country]) {

                            $array_race[$index] = $array_compare[$country];


                            $race = $array_compare[$country];
                            $arry_total[$race]+= $val;
                            $next=1;
                            }
                            else
                            {
                                $array_country[$country][$index]++;
                                $array_country_data[$country] = $r['region'] . ' ' . $r['subregion'] . ' ' . $r['latlng'];
                            }


                            $content[$index]+= $val;

                        }
                        arsort($content);
                        $content_string =$ethnic_country.'<br>----- Ethnic data -----<br>';
                        foreach ($content as $race=>$val)
                        {
                            $content_string.=$race.' ('.$array_compare[$race].') : '.$val.' %<br>';
                        }
                       arsort($arry_total);
                        $key = array_keys($arry_total);
                        $value = $arry_total[$key[0]];

                        if ($next)
                            {
                       $array_movie_bell[$key[0]][$cca2] = array($country,$content_string,$last_summ,$last_year);
                        // echo $country . ' ' . $key[0] . '-' . $value . '<br>';
                            }


        }


        $result_data = '';


        foreach ($array_movie_bell as $ethnic => $data) {
            $result_in = '';

            foreach ($data as $cca2 => $val) {

                $result_in .= "{ name: '" . $val[0] . "', code2: '" . $cca2 . "', value: '" . $val[2] . "', year:'" . $val[3] . "', content:'" . $val[1] . "'},";

            }

            $result_data .= "{  data: [" . $result_in . "],
                       joinBy: ['iso-a2', 'code2'],
                       name: '" . $ethnic . "',
                           dataLabels: {
                          // enabled: true,
                         ///  format: '{point.name}'
   
                       }  ,
                       tooltip: {
                    headerFormat: '',
                    pointFormat: '<p>{point.name}</p><br><p>{point.content}</p>'
                },
                
                color: '" . $array_ethnic_color[$ethnic] . "',
                
                },";
        }


        arsort($array_race);

        /*
        foreach ($array_race as $race=>$val)
        {
            echo "'".$race."' => '".$val."',<br>";
        }



        foreach ($array_country as $country => $data) {
            foreach ($data as $name => $count) {

                echo $name . '  ( ' . $country . ' )  ' . $array_country_data[$country] . '<br>';
            }

        }
        */
    }

    else if ($display_select == 'world_population') {
        $array_country = [];
        $array_total = [];
        $array_world=[];
        $array_country_data = [];
        $array_total_country=[];

        $sql = "SELECT *  FROM `data_population_country`";
        ///echo $sql.PHP_EOL;
        $q = $pdo->prepare($sql);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);

        while ($r = $q->fetch()) {

            $country = $r['country_name'];

            $ethnic_array = $r['ethnic_array'];
            $array_result = json_decode($ethnic_array);


            $population_data = $r['population_data'];
            $population_data_result = json_decode($population_data);

            $populatin_by_year = $r['populatin_by_year'];
            $populatin_by_year_result = json_decode($populatin_by_year);


            $populatin_result = [];

            foreach ($population_data_result as $year => $data) {
                if ($year > date('Y', time())) {
                    $populatin_result[$year] = $data;
                }
            }


            foreach ($populatin_by_year_result as $year => $data) {
                if ($data > 0) {
                    $populatin_result[$year] = $data;
                }
            }


            // ksort($populatin_result);
            ///  echo $r['country_name'].'<br>';


            $ethnic_array_result = $r['ethnic_array_result'];



            if ($ethnic_array_result) {
                $ethnic_array_result = json_decode($ethnic_array_result, JSON_FORCE_OBJECT);
            }


            foreach ($populatin_result as $year => $summ)
            {

                $array_total_country[$year][$country] += $summ;


                if ($year >= $start && (($year <= $end) || ($end == date('Y', time())))) {

                    // $summ = $summ * 1000;
                    //echo '<br>year'.$year.' '.$summ.'<br>';
                    // $array_total[$country][$year] += $summ;


                    foreach ($ethnic_array_result as $race => $count) {


                        if ($count>0) {

                            $summ_result = ($count * $summ / 100);
                            $array_total[$race][$year] += $summ_result;
                            $array_world[$year] += $summ_result;

                            $array_country[$year][$race][$country] += $summ_result;

                        }

                    }

                }

            }

            //break;
        }

        $result_data = '';

        ///arsort($array_total);
        $array_none = [];
        foreach ($array_total as $name => $data) {

            ksort($data);
            /// var_dump($data);

            $result_in = '';

            foreach ($data as $year => $summ) {

                $summ = round($summ, 0);

                $world=$array_world[$year];

                $wpercent = round(($summ/$world)*100,2);


                $result_in .= "{ x: " . $year . ", y: " . $summ . ",world:'".$world."' ,wpercent: '".$wpercent."'},";

            }

            $result_data .= "{
                  name: '" . $name . "',
                    type: 'spline',
                   color: '" . $array_ethnic_color[$name] . "', 
                    marker: {            enabled: false        },
                  turboThreshold:0,
                  data: [" . $result_in . "]},";


            ///   echo $name.' '.$summ.'<br>';
        }

      ///  ksort($array_country);

        /*
        if (is_array($array_none)) {
            arsort($array_none);
            foreach ($array_country as $country => $data) {
                foreach ($data as $name => $count) {

                    echo $name . '  ( ' . $country . ' )  ' . $array_country_data[$country] . '<br>';
                }

            }
        }
*/




    }

    else if ($display_select == 'bubble' || $display_select == 'bellcurve' || $display_select == 'plurality_bellcurve' || $display_select == 'scatter'
        || $display_select == 'regression' || $display_select == 'performance_country'
        || $display_select == 'ethnicity' || $_POST['oper'] === 'get_movie_cast_data_total') {


        if ($display_select == 'performance_country') {
            $ijoin .= " INNER join data_movie_rank  on (data_movie_rank.MovieID =  data_movie_ethnic.movie_id ) ";
            $idopcnt .= " and (data_movie_rank.`Box Office Domestic` > 0 ) ";


        }
        else if ($display_xa_axis == 'Box Office International' || $display_xa_axis == 'Box Office Domestic'
            || $display_xa_axis == 'DVD Sales Domestic') {
            $ijoin .= " INNER join data_movie_rank  on (data_movie_rank.MovieID =  data_movie_ethnic.movie_id ) ";
            $idopcnt .= " and (data_movie_rank.`" . $display_xa_axis . "`>0) ";
        }
        if ($display_xa_axis == 'Box Office Profit actual' || $budget_min || $budget_max) {


            ///$ijoin .= " INNER join data_movie_budget  on (data_movie_budget.MovieID =  data_movie_ethnic.movie_id ) ";


            if ($budget_min || $budget_max) {
                if ($budget_min) {
                    $idopcnt .= " and data_movie_ethnic.`movie_budget`>=" . intval($budget_min) . " ";
                }
                if ($budget_max) {
                    $idopcnt .= " and data_movie_ethnic.`movie_budget`<=" . intval($budget_max) . " ";
                }
            } else if ($display_xa_axis == 'Box Office Profit actual') {
                $idopcnt .= " and data_movie_ethnic.`movie_budget`>0 ";
            }

        }


        $total_movies = 0;

        $sql = "SELECT * FROM `data_movie_ethnic` " . $ijoin . " WHERE  data_movie_ethnic.`Year` >= " . $start . " and data_movie_ethnic.`Year` <= " . $end . $idopcnt;
        // [Countries] => ["Italy"]


        ///echo $sql;


        $q = $pdo->prepare($sql);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);

        $array_years = [];
        $array_top_country = [];//////top 10 country

        $array_result = [];
        $result = [];
        $array_movie_bell = [];
        $array_movie_bell_total = [];
        while ($r = $q->fetch()) {


            $k = $inflation_array[$r['Year']];
            if (!$k) $k = 1;

            $movie_data = $r['ethnicdata'];
            if ($movie_data) {
                $array_movie_result = json_decode($movie_data, JSON_FORCE_OBJECT);
                if (($animation == 2 && $array_movie_result['Production'] == 'Live Action') || !$animation) {


                    $total_movies++;

                    /////////////////////////////////////////////////////////////////////////


                    $array_years = [];
                    $array_years[$r['Year']][$r['movie_id']] = $array_movie_result;


                    $ethnic_array = get_echnic($array_years, $ethnycity, $actor_type);


                    /// var_dump($ethnic_array[2]);
                    ////////////////////////////////////////////////////////////////////////////

                    $data = $ethnic_array[2][$r['Year']];


                    //// var_dump($ethnic_array);
                    if ($diversity_select != 'diversity') {
                        $data = normalise_array($data);
                    }


                    $conent = '';

                    arsort($data);


                    if ($_POST['oper'] === 'get_movie_cast_data_total') {

                        if (is_array($data)) {

                            //  $data= normalise_array($data);


                            foreach ($data as $name => $summ) {

                                $array_movie_bell[$name] += $summ;
                            }
                        }

                    } else if ($display_select == 'bellcurve') {
                        ///var_dump($data);

                        $array_names = [];
                        if (is_array($data)) {
                            foreach ($data as $name => $summ) {


                                if (($diversity_select == 'm_f' && ($name != 'NA')) || $diversity_select != 'm_f') {


                                    if ($display_xa_axis == 'Box Office International' || $display_xa_axis == 'Box Office Domestic' || $display_xa_axis == 'DVD Sales Domestic') {

                                        $box = $r[$display_xa_axis];
                                    } else if ($display_xa_axis == 'Box Office Profit actual') {

                                        $box = ($array_movie_result['box'] - ($r['movie_budget'] * 2.5)) / 2;

                                    } else {

                                        $box = $array_movie_result['box'];
                                    }

                                    if ($display_xa_axis == 'Movie release date') {
                                        $array_movie_bell[$name][$r['movie_id']]['x'] = $array_movie_result['movies_date'];
                                    } else {
                                        $array_movie_bell[$name][$r['movie_id']]['x'] = $box * $k;
                                    }

                                    $array_movie_bell[$name][$r['movie_id']]['y'] = $summ;
                                    $array_movie_bell[$name][$r['movie_id']]['title'] = $array_movie_result['title'];
                                    $array_movie_bell[$name][$r['movie_id']]['date'] = $array_movie_result['movies_date'];
                                    if (!in_array($name, $array_names)) {
                                        $array_names[] = $name;
                                    }

                                    $array_movie_bell_total[$name][0] += $box * $k;
                                    $array_movie_bell_total[$name][1]++;
                                }
                            }
                        }
                    } else if ($display_select == 'scatter' || $display_select == 'regression') {

                        if (is_array($data)) {
                            foreach ($data as $name => $summ) {

                                if ($display_xa_axis == 'Box Office International' || $display_xa_axis == 'Box Office Domestic' || $display_xa_axis == 'DVD Sales Domestic') {
                                    $box = $r[$display_xa_axis];
                                } else if ($display_xa_axis == 'Box Office Profit actual') {
                                    $box = ($array_movie_result['box'] - ($r['movie_budget'] * 2.5)) / 2;

                                    ///   echo $array_movie_result['box'].' - '.$r['movie_budget'].' = '.$box.'<br>';

                                } else {
                                    $box = $array_movie_result['box'];
                                }


                                if ($display_xa_axis == 'Movie release date') {
                                    $array_movie_bell[$name][$r['movie_id']]['y'] = ($array_movie_result['movies_date']) . '000';
                                } else {

                                    $array_movie_bell[$name][$r['movie_id']]['y'] = $box * $k;
                                }

                                $array_movie_bell[$name][$r['movie_id']]['x'] = $summ;
                                $array_movie_bell[$name][$r['movie_id']]['title'] = $array_movie_result['title'];
                                $array_movie_bell[$name][$r['movie_id']]['date'] = date('d.m.Y', $array_movie_result['movies_date']);
                            }
                        }
                    } else if ($display_select == 'plurality_bellcurve') {

                        if ($display_xa_axis == 'Box Office International' || $display_xa_axis == 'Box Office Domestic' || $display_xa_axis == 'DVD Sales Domestic') {

                            $box = $r[$display_xa_axis];
                        } else if ($display_xa_axis == 'Box Office Profit actual') {

                            $box = ($array_movie_result['box'] - ($r['movie_budget'] * 2.5)) / 2;


                        } else {

                            $box = $array_movie_result['box'];
                        }


                        if ($display_xa_axis == 'Movie release date') {
                            $box = ($array_movie_result['movies_date']) . '000';
                        } else {

                            $box = $box * $k;
                        }


                        if (is_array($data)) {

                            $array_result_pl = [];
                            $ki = 0;
                            $index = '';
                            $maxsumm = 0;
                            foreach ($data as $name => $summ) {
                                if ($ki == 0) {
                                    $index = $name;
                                    $maxsumm = $summ;
                                    $array_result_pl[$ki][0] = $name;
                                    $array_result_pl[$ki][1] = $summ;
                                } else if ($maxsumm == $summ && $maxsumm) {
                                    $array_result_pl[$ki][0] = $name;
                                    $array_result_pl[$ki][1] = $summ;
                                }
                                /// $conent .= $name . ': ' . $summ . ' %<br>';
                                $ki++;

                                $array_movie_bell_total[$name][0] += $box * $k;
                            }

                            foreach ($array_result_pl as $index => $val) {
                                /// $result[$val[0]] .= "{ x: " . $box   . ", y: " .$val[1] . ",  date: '" . date('d.m.Y', $array_movie_result['movies_date']) . "',title:'" . $array_movie_result['title'] . "',content:'" . $conent . "',movie_id:'" . $r['movie_id'] . "' },";

                                $array_movie_bell[$val[0]][$r['movie_id']]['y'] = $box;
                                $array_movie_bell[$val[0]][$r['movie_id']]['title'] = $array_movie_result['title'];
                                $array_movie_bell[$val[0]][$r['movie_id']]['x'] = $val[1];
                                $array_movie_bell[$val[0]][$r['movie_id']]['date'] = $array_movie_result['movies_date'];
                                if (!in_array($val[0], $array_names)) {
                                    $array_names[] = $val[0];
                                }
                            }
                        }
                    } else if ($display_select == 'bubble') {


                        if ($display_xa_axis == 'Box Office International' || $display_xa_axis == 'Box Office Domestic' || $display_xa_axis == 'DVD Sales Domestic') {

                            $box = $r[$display_xa_axis];
                        } else if ($display_xa_axis == 'Box Office Profit actual') {

                            $box = ($array_movie_result['box'] - ($r['movie_budget'] * 2.5)) / 2;


                        } else {

                            $box = $array_movie_result['box'];
                        }


                        if ($display_xa_axis == 'Movie release date') {
                            $box = ($array_movie_result['movies_date']) . '000';
                        } else {

                            $box = $box * $k;
                        }


                        if (is_array($data)) {

                            $array_result_pl = [];
                            $ki = 0;
                            $index = '';
                            $maxsumm = 0;
                            foreach ($data as $name => $summ) {
                                if ($ki == 0) {
                                    $index = $name;
                                    $maxsumm = $summ;
                                    $array_result_pl[$ki][0] = $name;
                                    $array_result_pl[$ki][1] = $summ;
                                } else if ($maxsumm == $summ && $maxsumm) {
                                    $array_result_pl[$ki][0] = $name;
                                    $array_result_pl[$ki][1] = $summ;
                                }
                                $conent .= $name . ': ' . $summ . ' %<br>';
                                $ki++;
                            }

                            foreach ($array_result_pl as $index => $val) {
                                $result[$val[0]] .= "{ x: " . $box . ", y: " . $val[1] . ",  date: '" . date('d.m.Y', $array_movie_result['movies_date']) . "',title:'" . $array_movie_result['title'] . "',content:'" . $conent . "',movie_id:'" . $r['movie_id'] . "' },";

                            }


                        }


                    } else if ($display_select == 'ethnicity') {

                        $box = 0;

                        if ($display_xa_axis == 'Box Office International' || $display_xa_axis == 'Box Office Domestic' || $display_xa_axis == 'DVD Sales Domestic') {

                            $box = $r[$display_xa_axis];
                        } else if ($display_xa_axis == 'Box Office Profit actual') {

                            $box = ($array_movie_result['box'] - ($r['movie_budget'] * 2.5)) / 2;


                        } else {

                            $box = $array_movie_result['box'];
                        }


                        $box = $box * $k;


                        if (is_array($data)) {

                            //  $data= normalise_array($data);


                            foreach ($data as $name => $summ) {
                                $array_result[$r['Year']][$name] += $summ;

                                $array_movie_bell[$r['Year']] += $box;
                            }
                        }


                    } else if ($display_select == 'performance_country') {


                        $array_compare_country = array('United Kingdom' => 'UK');


                        $box_domestic = $r['Box Office Domestic'];
                        $box_internal = $r['Box Office International'];
                        $box_country = $r['Box Office Country'];


                        if ($box_country) {

                            $array_country = json_decode($box_country);

                            foreach ($array_country as $country => $summc) {

                                if ($array_compare_country[$country]) {
                                    $country = $array_compare_country[$country];
                                }


                                if ($summc > 0) {

                                    $array_result[$country] += $summc * $k;
                                    $array_top_country[$country]['box'] += $summc * $k;

                                    $array_top_country[$country]['count'] += 1;


                                    if (is_array($data)) {

                                        foreach ($data as $name => $summ) {

                                            $array_top_country[$country]['race'][$name] += $summ;

                                        }
                                    }

                                }
                            }
                        }


                        //////////domestic
                        $acntr_string = $r['movie_country'];
                        if (strstr($acntr_string, '|')) {
                            $acntr = explode('|', $acntr_string);
                            $dcntr = trim($acntr[0]);
                        } else {
                            $dcntr = trim($acntr_string);
                        }
                        /// echo 'dcntr. '.$dcntr.'<br>';


                        if ($box_domestic) {
                            $array_result[$dcntr] += $box_domestic * $k;
                            $array_top_country[$dcntr]['box'] += $box_domestic * $k;
                            $array_top_country[$dcntr]['count'] += 1;
                            if (is_array($data)) {
                                foreach ($data as $name => $summ) {

                                    $array_top_country[$dcntr]['race'][$name] += $summ;

                                }
                            }

                        }


                    }
                }
            }

        }


        if ($_POST['oper'] === 'get_movie_cast_data_total') {

            arsort($array_movie_bell);

            $array_movie_bell = normalise_array($array_movie_bell);

            $actor_content = set_table_ethnic($array_movie_bell,$_POST['id'] );
            echo $actor_content . '<br>';

            return;

        }

        if ($display_select == 'performance_country') {
            $result_in = '';

            arsort($array_result);
            uksort($array_top_country, function ($a, $b) use ($array_result) {
                return $array_result[$b] - $array_result[$a];
            });
            ///    var_dump($array_top_country);

            $i = 0;
            $race_array = [];


            foreach ($array_top_country as $country_name => $data0) {

                $race = $data0['race'];


                $race = normalise_array($race);
                arsort($race);
                foreach ($race as $name => $count) {

                    /// echo $country_name.' '.$name.' '.$count.'<br>';


                    $race_array[$name][$country_name] += $count;
                }

            }

            $array_all_country = [];
            foreach ($array_top_country as $country_name => $data0) {


                $box_office = $data0['box'];
                $movie_count = $data0['count'];
                if (!$movie_count) $movie_count = 0;

                ///$result_in .= "{ x: '" . $country_name . "', y: " . $box_office . "},";
                $array_all_country[] = $country_name;

                $categories .= "'" . $country_name . "',";

                $result_in .= $box_office . ",";

                $result_movie .= round($box_office / $movie_count, 0) . ",";

                $i++;

            }

            $result_data .= "{
             name: 'Box Office total',
             color: '" . $array_ethnic_color['Box Office total'] . "',
        type: 'spline',
         zIndex: 2,  
        data: [" . $result_in . "],
                marker: {
              radius: 8
        },
         lineWidth: 4,
         yAxis: 1, 
        tooltip: {
             valuePrefix: '$ '
        }} 
        ,{
        name: 'Box Office per movie',
        color: '" . $array_ethnic_color['Box Office per movie'] . "',

        type: 'spline',
       zIndex: 1,
        lineWidth: 4,
        data: [" . $result_movie . "],
        marker: {
              radius: 8
        },

        tooltip: {
            valuePrefix: '$ '
        }

    },";

            $i = 0;


            // var_dump($array_all_race);

            foreach ($race_array as $race => $data_race) {

                ///   var_dump($data_race);
                $result_race = '';
                foreach ($array_all_country as $country_name) {

                    /// echo $country_name.'<br> ';


                    $count = $data_race[$country_name];
                    if (!$count) {
                        $count = 0;
                    }
                    $result_race .= $count . ",";
                }


                $result_data .= "{
                     name: '" . $race . "',
        type: 'column',
        yAxis: 2,
         zIndex: -1,
          color: '" . $array_ethnic_color[$race] . "',
         data: [" . $result_race . "],
        tooltip: {
                     valueSuffix: ' %',
                    
        }

    }, ";

                $i++;
            }

//echo $result_data;
        } else if ($display_select == 'regression') {


            $n = 0;
            foreach ($array_movie_bell as $name => $data0) {
                $regression = '';
                $result_in = '';
                foreach ($data0 as $movie_id => $data) {

                    $regression .= '[' . $data['y'] . ',' . $data['x'] . '],';

                    $result_in .= "{ x: " . $data['y'] . ", y: " . $data['x'] . ", title:'" . $data['title'] . "',movie_id:'" . $movie_id . "', date:'" . $data['date'] . "' },";
                    //  $result_in.= $x . ',';
                }

                $result_data .= "{
                  name: '" . $name . "',
                    type:'scatter',
                     marker: {
                            radius: 3,
                        
                        },
                       color: '" . $array_ethnic_color[$name] . "', 
                  turboThreshold:0,
                  data: [" . $result_in . "],
     
                  }, 
                
                  {
                  name: '" . $name . " Regression',
                  type:'spline',
                            color: '" . $array_ethnic_color[$name] . "',
                    turboThreshold:0,
                  data: getregression([" . $regression . "],'" . $name . " Regression')},               
                  ";


                $n++;
///echo $name.'<br>';
            }
        } else if ($display_select == 'scatter') {


            foreach ($array_movie_bell as $name => $data0) {

                $result_in = '';
                foreach ($data0 as $movie_id => $data) {

                    $result_in .= "{ x: " . $data['y'] . ", y: " . $data['x'] . ", title:'" . $data['title'] . "',movie_id:'" . $movie_id . "', date:'" . $data['date'] . "' },";
                    //  $result_in.= $x . ',';
                }

                $result_data .= "{
                  name: '" . $name . "',
                  color: '" . $array_ethnic_color[$name] . "', 
                  turboThreshold:0,
                         marker: {
                            radius: 3,
                        
                        },
                  data: [" . $result_in . "]},";


///echo $name.'<br>';
            }
        } else if ($display_select == 'bellcurve' || $display_select == 'plurality_bellcurve') {

            $result_data_bell = '';
            $result_data = '';
            $i = 1;

            /// var_dump($array_movie_bell);

            foreach ($array_movie_bell as $name => $data0) {
////$array_movie_bell[$r['movie_id']][$name]['x']

                $result_in = '';


                foreach ($data0 as $movie_id => $data) {


                    $result_in .= "{ x: " . $data['y'] . ", y: " . $data['x'] . ",z:" . ($array_movie_bell_total[$name][0]) . ",  date: '" . date('d.m.Y', $data['date']) . "',title:'" . $data['title'] . "',movie_id:'" . $movie_id . "' },";

                    ////$result_in_bell .= $data['y'] . ',';

                }

                if (count($data0) > 1) {

                    $result_data_bell .= "{
                        name: '" . $name . " ',
                        type: 'bellcurve',
                        xAxis: 0,
                        yAxis: 1,
                           marker: {
                        enabled: false
                        },
                        baseSeries: '" . $name . "',
                       zIndex: -1,
                        pointsInInterval: pointsInInterval,
                      color: '" . $array_ethnic_color[$name] . "', 
        intervals: 4,
       /// marker: {            enabled: true        }
                       
                    },";

                    $result_data .= "{
                    id: '" . $name . "',
                  name: '" . $name . "',
                     type: 'scatter',
                      color: '" . $array_ethnic_color[$name] . "', 
                  turboThreshold:0,
    
                        visible :false,
                  data: [" . $result_in . "],
                  
                  },";

/// $result_remove .= "chart.series['".$name."'].remove(true);";
                    //  $i++;

                }
                $i += 1;
            }


            /// echo $result_data;

        } else if ($display_select == 'bubble') {
            ///echo 'total movies: ' . $total_movies . '<br>';

            foreach ($result as $index => $item) {

                $result_data .= "{
                  name: '" . $index . "',
        color: '" . $array_ethnic_color[$index] . "', 
                  turboThreshold:0,
                  data: [" . $item . "]},";

            }
        } else if ($display_select == 'ethnicity') {


            $array_temp = [];

            foreach ($array_result as $year => $data) {
                //     var_dump($data);
                $data = normalise_array($data);
                foreach ($data as $name => $val) {
                    $array_temp[$name][$year] = $val;
                }


            }

            foreach ($array_temp as $name => $data) {
                //$data0 = normalise_array($data);

                $result_in = '';

                foreach ($data as $Year => $summ) {

                    $box = $array_movie_bell[$Year];

                    $rs = round($summ, 2);

                    $smm = 0;

                    if ($rs) {
                        $smm = round(($box * $rs) / 100, 0);
                    }

                    $result_in .= "{ x: " . $Year . ", y: " . $smm . ",totalbox:" . $box . ",percent:" . $rs . "},";
                }

                //  $result_in.= $x . ',';
                $result_data .= "{
                  name: '" . $name . "',
                    color: '" . $array_ethnic_color[$name] . "', 
                 data: [" . $result_in . "]
                 },";

            }

        }

        ///  echo $result_data;
    }

    else if ($display_select == 'date_range_international' || $display_select == 'date_range_country')
    {

        ///foreach ($country as $country_value) {
        ///  echo $country_value.'<br>';

        $country_value = $country;

        if ($display_select == 'date_range_international' )
        {
            $DomesticBox = 1;
            $International = 1;
        }
        else if ($display_select == 'date_range_country')
        {
            $byCountry = 1;
        }

        if ($display_xa_axis == 'Box Office Profit actual' || $budget_min || $budget_max) {


            $join_dop .= " INNER join data_movie_budget  on (data_movie_budget.MovieID =  data_movie_rank.MovieID ) ";

            if ($budget_min || $budget_max) {
                if ($budget_min) {
                    $idop .= " and data_movie_budget.`Production_Budget`>=" . intval($budget_min) . " ";
                }
                if ($budget_max) {
                    $idop .= " and data_movie_budget.`Production_Budget`<=" . intval($budget_max) . " ";
                }


            } else if ($display_xa_axis == 'Box Office Profit actual') {
                $idop .= " and data_movie_budget.`Production_Budget`>0 ";
            }
            if (!$IMDb) {
                $idop .= " and data_movie_rank.`MovieID`>0 ";
            }

        }
        ///}

        $sql = "SELECT data_movie_rank.`Year`, data_movie_rank.`Box Office Domestic`, data_movie_rank.`Box Office International`,
 data_movie_rank.`Box Office Worldwide`, data_movie_rank.`Box Office Country` FROM  data_movie_rank " . $join_dop . " 
 WHERE data_movie_rank.`Year` >= " . $start . " and data_movie_rank.`Year` <= " . $end . "
  and (data_movie_rank.`Box Office Domestic` > 0 OR  data_movie_rank.`Box Office International` > 0 OR  data_movie_rank.`Box Office Country` > 0) " . $idop;


        // [Countries] => ["Italy"]
        //echo $sql;

        $q = $pdo->prepare($sql);
        $q->execute();
        $q->setFetchMode(PDO::FETCH_ASSOC);

        $array_years = [];
        $array_top_country = [];//////top 10 country


        while ($r = $q->fetch()) {
            $k = $inflation_array[$r['Year']];
            if (!$k) $k = 1;

            if ($DomesticBox) {
                $array_years[$r['Year']]['Box Office Domestic'] += $r['Box Office Domestic'] * $k;
            }
            if ($International) {
                $array_years[$r['Year']]['Box Office International'] += $r['Box Office International'] * $k;
            }


            if ($byCountry) {

                if ($r['Box Office Country']) {
                    $array_country = json_decode($r['Box Office Country']);
                    ///   var_dump($array_country);
                    foreach ($array_country as $country => $summ) {

                        $array_top_country[$country] += $summ * $k;

                        if ($summ > 0) {
                            $array_years[$r['Year']][$country] += $summ * $k;
                        }
                    }

                }

                arsort($array_top_country);

                $array_top_country = array_slice($array_top_country, 0, 10);


            }


        }


        $result_data = '';
        $data_years = '';
        $array_result = [];

        if (is_array($array_years)) {
            foreach ($array_years as $index => $val) {


                arsort($val);

                foreach ($val as $val_type => $count) {

                    if (($byCountry && $array_top_country[$val_type]) || !$byCountry) {

                        $array_result[$val_type] .= "{x:" . $index . ",y:" . $count . "},";


                    }
                }

            }
            if ($byCountry) {

                uksort($array_result, function ($a, $b) use ($array_top_country) {
                    return $array_top_country[$b] - $array_top_country[$a];
                });


            }

            foreach ($array_result as $val_type => $data) {


                $result_data .= "{   name: '" . $val_type . "',
                             data: [" . $data . "],
                               color: '" . $array_ethnic_color[$val_type] . "',
                             },";
            }


        }


        if ($byCountry) {

            foreach ($array_top_country as $name => $summ) {
                $array_name .= ", '" . $name . "'";
            }

        }
    }
    if ( $display_select == 'Buying_power_by_race') {
        ?>

             <script type="text/javascript">
                 $('#chart_div').height(500);
           var chart = Highcharts.chart('chart_div', {
                chart: {
                    type: 'column',
                    panning: true,
                },
               title: {
                   text: 'Buying Power by race Per Capita (<?php echo $yearmin ?>)'
               },
               /*
                plotOptions: {
                    series: {
                        grouping: false,
                        borderWidth: 0,

                                point: {
                                    events: {
                                        click: function (e) {

                                            var code2 = e.point.code2;
                                            var name = e.point.name;
                                            var data = get_data();

                                            var whait_html = '<div class="cssload-circle">\n' +
                                                '\t\t<div class="cssload-up">\n' +
                                                '\t\t\t\t<div class="cssload-innera"></div>\n' +
                                                '\t\t</div>\n' +
                                                '\t\t<div class="cssload-down">\n' +
                                                '\t\t\t\t<div class="cssload-innerb"></div>\n' +
                                                '\t\t</div>\n' +
                                                '</div>';

                                            $('div.footer_table_result').html(whait_html);


                                            $.ajax({
                                                type: "POST",
                                                url: "get_data.php",

                                                data: ({
                                                    oper: 'get_country_data',
                                                    id: name,
                                                    cur_year: '',
                                                    code2: code2,
                                                    data: JSON.stringify(data),

                                                }),
                                                success: function (html) {

                                                    $('.footer_table_result').html('<div class="clear_table"></div><div class="movie_content" id="' + name + '">' + html + '</div>');

                                                }
                                            });


                                        }
                                    }
                                }

                    }
                },
*/
               legend: {
                    enabled: false
                },
                tooltip: {
                    shared: true,
                    headerFormat: '<span style="font-size: 15px">{point.point.name}</span><br/>',
                    pointFormat: '<span style="color:{point.color}">\u25CF</span> {series.name}: <b> {point.y} </b><br>'
                },
                xAxis: {
                    type: 'category',

                },
                yAxis: [{
                    title: {
                        text: 'Buying Power'
                    },
                   showFirstLabel: false
                },{
                    opposite: true,
                    title: {
                        text: 'Population'
                    }
                }],

                series: [ {
                    name: 'Buying Power Per Capita',
                    id: 'main',
                    dataSorting: {
                       // enabled: true,
                      //  matchByName: true
                    },
                    dataLabels: [{
                        enabled: false,
                        inside: true,
                        style: {
                            fontSize: '16px'
                        }
                    }],
                    data:[<?php echo $result_in ?>]
                }, {
                    name: 'Population',
                    color: '#0026ff',
                    type: 'spline',
                    zIndex: 2,
                    data: [<?php echo $result_in_pop ?>],
                     marker: {
                     radius: 6,
                         color: '#0026ff',
                         states: {
                         hover: {
                             enabled: true,

                         }
                     }
                 },
                    lineWidth: 4,
                    yAxis: 1,
                    tooltip: {
                    ///    valuePrefix: '$ '
                    }
               }],
                exporting: {
                    allowHTML: true
                }
            });
                 $('.change_buying_power ').click(function () {
                     var stack = $(this).attr('id');

                     if (stack == 'all_data') {
                         $(this).attr('id', 'per_capita').html('Stacking by per capita');

                         chart.title.update({
                             text: 'Buying Power by race Total (<?php echo $yearmin ?>)'
                         });


                         chart.series[0].update({
                             data: [<?php echo $result_in_all ?>],
                             name:'Purchasing Power Total'
                         }, false);
                         chart.series[1].update({
                             data: [<?php echo $result_in_pop_all ?>]
                         }, false);
                     }
                     else {

                         $(this).attr('id', 'all_data').html('Stacking by All data');


                         chart.title.update({
                             text: 'Buying Power by race Per Capita (<?php echo $yearmin ?>)'
                         });


                         chart.series[0].update({
                             data: [<?php echo $result_in ?>],
                             name:'Purchasing Power Per Capita'
                         }, false);
                         chart.series[1].update({
                             data: [<?php echo $result_in_pop ?>]
                         }, false);
                     }

                     chart.redraw();
                   });
           </script>

        <button class="change_buying_power button_big" id="all_data">Stacking by All data</button>

        <?php }

    else if ( $display_select == 'Buying_power') {
        ?>

        <script type="text/javascript">

            $('#chart_div').height(700);

            var chart = Highcharts.mapChart('chart_div', {

                chart: {
                    map: 'custom/world'
                },

                title: {
                    text: 'Purchasing Power Parity (Per Capita)'
                },

                legend: {
                    title: {
                        text: 'Buying Power',
                    }
                },
                plotOptions: {
                    map: {
                    ///    allAreas: false,
                    },

                    series: {
                        point: {
                            events: {
                                click: function (e) {


                                    /// console.log(e);


                                    var code2 = e.point.code2;
                                    var name = e.point.name;
                                    var data = get_data();

                                    var whait_html = '<div class="cssload-circle">\n' +
                                        '\t\t<div class="cssload-up">\n' +
                                        '\t\t\t\t<div class="cssload-innera"></div>\n' +
                                        '\t\t</div>\n' +
                                        '\t\t<div class="cssload-down">\n' +
                                        '\t\t\t\t<div class="cssload-innerb"></div>\n' +
                                        '\t\t</div>\n' +
                                        '</div>';

                                    $('div.footer_table_result').html(whait_html);


                                    $.ajax({
                                        type: "POST",
                                        url: "get_data.php",

                                        data: ({
                                            oper: 'get_country_data',
                                            id: name,
                                            cur_year: '',
                                            code2: code2,
                                            data: JSON.stringify(data),

                                        }),
                                        success: function (html) {

                                            $('.footer_table_result').html('<div class="clear_table"></div><div class="movie_content" id="' + name + '">' + html + '</div>');

                                        }
                                    });


                                }
                            }
                        }
                    },
                },
                mapNavigation: {
                    enabled: true,
                    buttonOptions: {
                        verticalAlign: 'bottom'
                    }
                },
                tooltip: {
                    headerFormat: '',
                    //useHTML: true,
                    pointFormat: '<p>{point.name}</p><br><p>Buying Power (Per Capita): <b>$ {point.value}</b></p><br><p>Buying Power (Total): $ {point.total}</p><br><p>Year: {point.year}</p>'
                },

      colorAxis: {
     min:<?php echo $per_capita_min ?>,
     max:<?php echo $per_capita_max ?>,
    //  type: 'logarithmic',
      minColor: '#dbe3ff',
      maxColor: '#000016',
          stops: [
              [0, '#EFEFFF'],
              [0.13, '#004c78'],
              [0.62, '#000322'],
              [1, '#000000']
          ]
    },

                series: [
                    <?php echo $result_data; ?>

                ]

            });





            var chart2 = Highcharts.chart('chart_div_2', {
                chart: {
                    type: 'column',
                    panning: true,
                },
                title: false,

                plotOptions: {
                    series: {
                        grouping: false,
                        borderWidth: 0,





                                point: {
                                    events: {
                                        click: function (e) {


                                            /// console.log(e);


                                            var code2 = e.point.code2;
                                            var name = e.point.name;
                                            var data = get_data();

                                            var whait_html = '<div class="cssload-circle">\n' +
                                                '\t\t<div class="cssload-up">\n' +
                                                '\t\t\t\t<div class="cssload-innera"></div>\n' +
                                                '\t\t</div>\n' +
                                                '\t\t<div class="cssload-down">\n' +
                                                '\t\t\t\t<div class="cssload-innerb"></div>\n' +
                                                '\t\t</div>\n' +
                                                '</div>';

                                            $('div.footer_table_result').html(whait_html);


                                            $.ajax({
                                                type: "POST",
                                                url: "get_data.php",

                                                data: ({
                                                    oper: 'get_country_data',
                                                    id: name,
                                                    cur_year: '',
                                                    code2: code2,
                                                    data: JSON.stringify(data),

                                                }),
                                                success: function (html) {

                                                    $('.footer_table_result').html('<div class="clear_table"></div><div class="movie_content" id="' + name + '">' + html + '</div>');

                                                }
                                            });


                                        }
                                    }
                                }

                    }
                },
                legend: {
                    enabled: false
                },
                tooltip: {
                    shared: true,
                    headerFormat: '<span style="font-size: 15px">{point.point.country}</span><br/>',
                    pointFormat: '<span style="color:{point.color}">\u25CF</span> {series.name}: <b>{point.y} </b><br/>'
                },
                xAxis: {
                    type: 'category',
                    max: 10,
                    scrollbar: {
                        enabled: true
                    },
                    labels: {
                        useHTML: true,
                        animate: true,
                        formatter: function () {
                         ////   console.log(this);
                            var output = this.value;
                            return '<span><img src="/database/country_data/' + output + '.svg" style="width: 40px; height: 40px;"/><br></span>';
                        }
                    }
                },
                yAxis: [{
                    title: {
                        text: 'Buying Power'
                    },
                   showFirstLabel: false
                }],
                colorAxis: {
                    min:<?php echo $per_capita_min ?>,
                    max:<?php echo $per_capita_max ?>,
                    //  type: 'logarithmic',
                    minColor: '#dbe3ff',
                    maxColor: '#000016',
                    stops: [
                        [0, '#EFEFFF'],
                        [0.13, '#004c78'],
                        [0.62, '#000322'],
                        [1, '#000000']
                    ]
                },
                series: [ {
                    name: 'Buying Power Per Capita',
                    id: 'main',
                    dataSorting: {
                        enabled: true,
                        matchByName: true
                    },
                    dataLabels: [{
                        enabled: false,
                        inside: true,
                        style: {
                            fontSize: '16px'
                        }
                    }],
                    data: [<?php echo $result_c ?>]
                }],
                exporting: {
                    allowHTML: true
                }
            });


            $('.change_buying_power ').click(function () {
                var stack = $(this).attr('id');

                if (stack == 'all_data') {
                    $(this).attr('id', 'per_capita').html('Stacking by per capita');

                    //  console.log(chart);


                    chart.title.update({
                        text: 'Purchasing Power Total'
                    });

                    chart.tooltip.update({
                        pointFormat: '<p>{point.name}</p><br><p>Buying Power (Total): <b>$ {point.value}</b></p><br><p>Buying Power (Per Capita): $ {point.total}</p><br><p>Year: {point.year}</p>'
                    });

                    chart.colorAxis[0].update({
                        min:<?php echo $all_data_min ?>,
                        max:<?php echo $all_data_max ?>,
                        //  type: 'logarithmic',
                        minColor: '#dbe3ff',
                        maxColor: '#000016',
                        stops: [
                            [0, '#EFEFFF'],
                            [0.13, '#004c78'],
                            [0.62, '#000858'],
                            [1, '#000000']
                        ]
                    }, false);


                    chart.series[0].update({
                        data: [<?php echo $result_in_all ?>]
                    }, false);

                    ////////$result_c

                    chart2.colorAxis[0].update({
                        min:<?php echo $all_data_min ?>,
                        max:<?php echo $all_data_max ?>,
                        //  type: 'logarithmic',
                        minColor: '#dbe3ff',
                        maxColor: '#000016',
                        stops: [
                            [0, '#EFEFFF'],
                            [0.13, '#004c78'],
                            [0.62, '#000858'],
                            [1, '#000000']
                        ]
                    }, false);


                    chart2.series[0].update({
                        data: [<?php echo $result_c_all ?>],
                        name:'Purchasing Power Total'
                    }, false);
                }
                else {

                    $(this).attr('id', 'all_data').html('Stacking by All data');


                    chart.title.update({
                        text: 'Purchasing Power Parity (Per Capita)'
                    });
                    chart.tooltip.update({
                        pointFormat: '<p>{point.name}</p><br><p>Buying Power (Per Capita): <b>$ {point.value}</b></p><br><p>Buying Power (Total): $ {point.total}</p><br><p>Year: {point.year}</p>'
                    });

                    chart.colorAxis[0].update({
                        min:<?php echo $per_capita_min ?>,
                        max:<?php echo $per_capita_max ?>,
                        // type: 'logarithmic',
                        minColor: '#dbe3ff',
                        maxColor: '#000016',
                        stops: [
                            [0, '#EFEFFF'],
                            [0.21, '#004c78'],
                            [0.62, '#000322'],
                            [1, '#000000']
                        ]
                    }, false);

                    chart.series[0].update({
                        data: [<?php echo $result_in ?>]
                    }, false);

//////////////////


                    chart2.colorAxis[0].update({
                        min:<?php echo $per_capita_min ?>,
                        max:<?php echo $per_capita_max ?>,
                        // type: 'logarithmic',
                        minColor: '#dbe3ff',
                        maxColor: '#000016',
                        stops: [
                            [0, '#EFEFFF'],
                            [0.21, '#004c78'],
                            [0.62, '#000322'],
                            [1, '#000000']
                        ]
                    }, false);

                    chart2.series[0].update({
                        data: [<?php echo $result_c ?>],
                        name:'Purchasing Power Per Capita'
                    }, false);


                }

                chart.redraw();
                chart2.redraw();
            });



        </script>



        <div id="chart_div_2" style="width: 100%; height: 400px"></div>
        <button class="change_buying_power button_big" id="all_data">Stacking by All data</button>



       <?php }

  else  if ($display_select == 'world_map') {
        ?>


        <script type="text/javascript">

            $('#chart_div').height(700);
            // Create the chart

            /*
                        // New map-pie series type that also allows lat/lon as center option.
            // Also adds a sizeFormatter option to the series, to allow dynamic sizing
            // of the pies.
            Highcharts.seriesType('mappie', 'pie', {
              center: null, // Can't be array by default anymore
              clip: true, // For map navigation
              states: {
                hover: {
                  halo: {
                    size: 5
                  }
                }
              },
              linkedMap: null, //id of linked map
              dataLabels: {
                enabled: false
              }
            }, {
              render: function () {
                var series = this,
                  chart = series.chart,


                  linkedSeries = chart.get(series.options.id);
                Highcharts.seriesTypes.pie.prototype.render.apply(series, arguments);
                if (series.group && linkedSeries) {
                  series.group.add(linkedSeries.group);
                }

              },

              getCenter: function () {
                var options = this.options,
                  chart = this.chart,
                  slicingRoom = 2 * (options.slicedOffset || 0);
               /// console.log('options',options);
                if (!options.center) {
                  options.center = [null, null]; // Do the default here instead
                }
                // Handle lat/lon support
                if (options.center.plotX !== undefined) {

                  options.center = [
                    chart.xAxis[0].toPixels(options.center.plotX, true) ,
                    chart.yAxis[0].toPixels(options.center.plotY, true)
                  ];
                }
                // Handle dynamic size
                if (options.sizeFormatter) {
                  options.size = options.sizeFormatter.call(this);
                }
                // Call parent function
                var result = Highcharts.seriesTypes.pie.prototype.getCenter.call(this);
                // Must correct for slicing room to get exact pixel pos
                result[0] -= slicingRoom;
                result[1] -= slicingRoom;
                return result;
              },


              translate: function (p) {
                this.options.center = this.userOptions.center;
                this.center = this.getCenter();
                return Highcharts.seriesTypes.pie.prototype.translate.call(this, p);
              }


            });
            */

            var chart = Highcharts.mapChart('chart_div', {
                chart: {
                    map: 'custom/world',
                    ///styledMode: true
                },

                title: {
                    text: 'Ethnic world map'
                },
                plotOptions: {
                    map: {
                        allAreas: false,
                    },
                    tooltip: {
                        headerFormat: '<p>{series.name}</p>',
                        pointFormat: '{point.content}'
                    },

                        series: {
                            point: {
                                events: {
                                    click: function (e) {


                                       /// console.log(e);


                                        var code2 = e.point.code2;
                                        var name = e.point.name;
                                        var data = get_data();

                                        var whait_html = '<div class="cssload-circle">\n' +
                                            '\t\t<div class="cssload-up">\n' +
                                            '\t\t\t\t<div class="cssload-innera"></div>\n' +
                                            '\t\t</div>\n' +
                                            '\t\t<div class="cssload-down">\n' +
                                            '\t\t\t\t<div class="cssload-innerb"></div>\n' +
                                            '\t\t</div>\n' +
                                            '</div>';

                                        $('div.footer_table_result').html(whait_html);


                                        $.ajax({
                                            type: "POST",
                                            url: "get_data.php",

                                            data: ({
                                                oper: 'get_country_data',
                                                id: name,
                                                cur_year:'',
                                                code2:code2,
                                                data: JSON.stringify(data),

                                            }),
                                            success: function (html) {

                                           $('.footer_table_result').html('<div class="clear_table"></div><div class="movie_content" id="' + name + '">' + html + '</div>');

                                            }
                                        });


                                    }
                                }
                            }
                        },








                },

                mapNavigation: {
                    enabled: true,
                    buttonOptions: {
                        verticalAlign: 'bottom'
                    }
                },

                series: [
                    <?php echo $result_data; ?>

                ]
            });


            /*
            var data = [
                // state, demVotes, repVotes, libVotes, grnVotes, sumVotes, winner, offset config for pies
                ['RU', 729547, 1318255, 44467, 9391, 2101660, -1],
                ['US', 1367716, 1322951, 112972, 36985, 2840624, 1, { lon: -1, drawConnector: false }],
                ['CN', 1967444, 1509688, 72143, 37131, 3586406, 3, { lat: -1, lon: 1.2 }],

              ],

              maxVotes = 0,
              demColor = 'rgba(74,131,240,0.80)',
              repColor = 'rgba(220,71,71,0.80)',
              libColor = 'rgba(240,190,50,0.80)',
              grnColor = 'rgba(90,200,90,0.80)';

                        /*
                        // Compute max votes to find relative sizes of bubbles
                        Highcharts.each(data, function (row) {
                          maxVote= Math.max(maxVotes, row[5]);
                        });
                        /*
                        // Build the chart
                        var chart = Highcharts.mapChart('chart_div', {
                          title: {
                            text: 'Population'
                          },

                          chart: {
                              ///styledMode: true,
                            animation: false // Disable animation, especially for zooming
                          },

                          colorAxis: {
                            dataClasses: [{
                              from: -1,
                              to: 0,
                              color: 'rgba(244,91,91,0.5)',
                              name: 'Republican'
                            }, {
                              from: 0,
                              to: 1,
                              color: 'rgba(124,181,236,0.5)',
                              name: 'Democrat'
                            }, {
                              from: 2,
                              to: 3,
                              name: 'Libertarian',
                              color: libColor
                            }, {
                              from: 3,
                              to: 4,
                              name: 'Green',
                              color: grnColor
                            }]
                          },

                          mapNavigation: {
                            enabled: true
                          },

                          // Limit zoom range

                          yAxis: {
                           // minRange: 2300
                          },

                          tooltip: {
                            useHTML: true
                          },

                          // Default options for the pies
                          plotOptions: {
                              map: {
                                  allAreas: false,
                              },
                            mappie: {
                              borderColor: 'rgba(255,255,255,0.4)',
                              borderWidth: 1,
                              tooltip: {
                                headerFormat: ''
                              }
                            }
                          },

                          series: [{
                            mapData: Highcharts.maps['custom/world'],
                            data: data,
                            name: 'States',
                            borderColor: '#FFF',
                            showInLegend: false,
                           // joinBy: ['name', 'id'],
                            joinBy: ['iso-a2', 'id'],
                            keys: ['id', 'demVotes', 'repVotes', 'libVotes', 'grnVotes',
                              'sumVotes', 'value', 'pieOffset'],
                            tooltip: {
                              headerFormat: '',
                              pointFormatter: function () {
                                var hoverVotes = this.hoverVotes; // Used by pie only
                                return '<b>' + this.id + ' votes</b><br/>' +
                                  Highcharts.map([
                                    ['Democrats', this.demVotes, demColor],
                                    ['Republicans', this.repVotes, repColor],
                                    ['Libertarians', this.libVotes, libColor],
                                    ['Green', this.grnVotes, grnColor]
                                  ].sort(function (a, b) {
                                    return b[1] - a[1]; // Sort tooltip by most votes
                                  }), function (line) {
                                    return '<span style="color:' + line[2] +
                                      // Colorized bullet
                                      '">\u25CF</span> ' +
                                      // Party and votes
                                      (line[0] === hoverVotes ? '<b>' : '') +
                                      line[0] + ': ' +
                                      Highcharts.numberFormat(line[1], 0) +
                                      (line[0] === hoverVotes ? '</b>' : '') +
                                      '<br/>';
                                  }).join('') +
                                  '<hr/>Total: ' + Highcharts.numberFormat(this.sumVotes, 0);
                              }
                            }
                          }

                          , {
                              name: 'Separators',
                              id: 'us-all',
                              type: 'mapline',
                              data: Highcharts.geojson(Highcharts.maps['countries/us/us-all'], 'mapline'),
                              color: '#707070',
                              showInLegend: false,
                              enableMouseTracking: false
                          }, {
                              name: 'Connectors',
                              type: 'mapline',
                              color: 'rgba(130, 130, 130, 0.5)',
                              zIndex: 5,
                              showInLegend: false,
                              enableMouseTracking: false
                          }

                          ]
                        });

                        */
            /*
            // When clicking legend items, also toggle connectors and pies
            Highcharts.each(chart.legend.allItems, function (item) {
              var old = item.setVisible;
              item.setVisible = function () {
                var legendItem = this;
                old.call(legendItem);
                Highcharts.each(chart.series[0].points, function (point) {
                  if (chart.colorAxis[0].dataClasses[point.dataClass].name === legendItem.name) {
                    // Find this state's pie and set visibility
                    Highcharts.find(chart.series, function (item) {
                      return item.name === point.id;
                    }
                    ).setVisible(legendItem.visible, false);
                    // Do the same for the connector point if it exists
                    var connector = Highcharts.find(chart.series[2].points, function (item) {
                      return item.name === point.id;
                    });
                    if (connector) {
                      connector.setVisible(legendItem.visible, false);
                    }
                  }
                });
                chart.redraw();
              };
            });


            // Add the pies after chart load, optionally with offset and connectors
            Highcharts.each(chart.series[0].points, function (state) {
              if (!state.id) {
                return; // Skip points with no data, if any
              }

            console.log(state);

              var pieOffset = state.pieOffset || {},
                centerLat = parseFloat(state._midX),
                centerLon = parseFloat(state._midY);

              //console.log(centerLat,centerLon);

              // Add the pie for this state
              chart.addSeries({
                type: 'mappie',
                name: state.id,
                linkedMap: 'custom/world',
                zIndex: 10, // Keep pies above connector lines
                sizeFormatter: function () {
                  var yAxis = this.chart.yAxis[0],
                    zoomFactor = (yAxis.dataMax - yAxis.dataMin) /
                      (yAxis.max - yAxis.min);
                  return Math.max(
                    this.chart.chartWidth / 45,// * zoomFactor, // Min size
                    this.chart.chartWidth / 11 // * zoomFactor * state.sumVotes / maxVotes
                  );
                },


                tooltip: {
                  // Use the state tooltip for the pies as well
                  pointFormatter: function () {
                    return state.series.tooltipOptions.pointFormatter.call({
                      id: state.id,
                      hoverVotes: this.name,
                      demVotes: state.demVotes,
                      repVotes: state.repVotes,
                      libVotes: state.libVotes,
                      grnVotes: state.grnVotes,
                      sumVotes: state.sumVotes
                    });
                  }
                },

                data: [{
                  name: 'Democrats',
                  y:10,// state.demVotes,
                 // color: demColor
                }, {
                  name: 'Republicans',
                  y: 5,//state.repVotes,
                //  color: repColor
                }, {
                  name: 'Libertarians',
                  y:80,/// state.libVotes,
               //   color: libColor
                }, {
                  name: 'Green',
                  y:5,/// state.grnVotes,
                 // color: grnColor
                }],
                center: {
                    plotX: centerLat ,
                    plotY: centerLon ,
                }
              }, false);

            //  console.log(chart);

              // Draw connector to state center if the pie has been offset
              if (pieOffset.drawConnector !== false) {
                var centerPoint = chart.fromLatLonToPoint({
                    lat: centerLat,
                    lon: centerLon
                  }),
                  offsetPoint = chart.fromLatLonToPoint({
                    lat: centerLat + (pieOffset.lat || 0),
                    lon: centerLon + (pieOffset.lon || 0)
                  });
                chart.series[2].addPoint({
                  name: state.id,
                  path: 'M' + offsetPoint.x + ' ' + offsetPoint.y +
                    'L' + centerPoint.x + ' ' + centerPoint.y
                }, false);
              }


            }
            );
            // Only redraw once all pies and connectors have been added

            chart.redraw();

                        console.log(chart);



            */


        </script>

    <?php }
    else if ($display_select == 'world_population') {
        ?>

        <script type="text/javascript">

            Highcharts.chart('chart_div', {
                chart: {

                    zoomType: 'xy',
                    ///styledMode: true
                },
                title: {
                    text: 'World population'
                },

                xAxis: {
                    title: {
                        text: 'Year',

                    },
                },
                yAxis: {
                    title: {
                        text: 'Total',

                    },
                },
                legend: {
                    maxHeight: 70,
                },
                tooltip: {

                    pointFormat: '<strong>{series.name}</strong><br><p>Population: <b>{point.y:.0f}</b></p><br><p>Percent: <b>{point.wpercent} %</b></p>',

                    //shared: true
                },


                plotOptions: {



                    series: {
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function (e) {


                                    var m_id = e.point.x;
                                    var race = e.point.series.name;
                                    var data = get_data();

                                    var whait_html = '<div class="cssload-circle">\n' +
                                        '\t\t<div class="cssload-up">\n' +
                                        '\t\t\t\t<div class="cssload-innera"></div>\n' +
                                        '\t\t</div>\n' +
                                        '\t\t<div class="cssload-down">\n' +
                                        '\t\t\t\t<div class="cssload-innerb"></div>\n' +
                                        '\t\t</div>\n' +
                                        '</div>';

                                    $('div.footer_table_result').html(whait_html);

                                    $.ajax({
                                        type: "POST",
                                        url: "get_data.php",

                                        data: ({
                                            oper: 'get_race_data',
                                            id: m_id,
                                            race: race,
                                            data: data
                                        }),
                                        success: function (html) {
                                            $('.footer_table_result').html('<div class="clear_table"></div><div class="movie_content" id="race_' + m_id + '">' + html + '</div>');


                                        }
                                    });


                                }
                            }
                        }
                    },

                },


                series: [<?php echo $result_data; ?>]
            });

        </script>

        <?php


    }
    else if ($display_select == 'bellcurve' || $display_select == 'plurality_bellcurve') {
        ?>


        <script type="text/javascript">

            var pointsInInterval = 5;

            var chart = Highcharts.chart('chart_div', {

                title: {
                    <?php if ($display_select == 'bellcurve') {
                        echo "text: 'Bell curve'";
                    } else if ($display_select == 'plurality_bellcurve') {
                        echo "text: 'Plurality Bell curve'";
                    } ?>


                },

                chart: {
                    zoomType: 'xy',
                    ///styledMode: true,
                    /*
                    events: {
                        load: function () {
                            var current = this;

                            for (i = 0; i < <?php echo count($array_names); ?>; i++) {
                                Highcharts.each(current.series[i].data, function (point, i) {
                                    ////  console.log(point, i);
                                    var labels = ['4σ', '3σ', '2σ', 'σ', 'μ', 'σ', '2σ', '3σ', '4σ'];
                                    if (i % pointsInInterval === 0) {
                                        point.update({
                                            color: 'black',
                                            dataLabels: {
                                                enabled: true,
                                                format: labels[Math.floor(i / pointsInInterval)],
                                                overflow: 'none',
                                                crop: false,
                                                y: -2,
                                                style: {
                                                    fontSize: '13px'
                                                }
                                            }
                                        });
                                    }
                                });

                            }

                        }
                    }
                    */
                },
                xAxis: [{
                    title: {

                        <?php if ($display_select == 'bellcurve') {
                            echo "text: 'Percent'";
                        } else if ($display_select == 'plurality_bellcurve') {
                            echo "text: '" . $display_xa_axis . "'";
                        } ?>


                    },

                    <?php if ($display_xa_axis == 'Movie release date') { ?>
                    type: 'datetime',

                    <?php } ?>
                }]
                ,

                yAxis: [{
                    title: {
                        <?php if ($display_select == 'bellcurve') {
                            echo "text: '" . $display_xa_axis . "'";
                        } ?>
                    }
                },
                    {
                        title: {text: 'Bell curve'},
                        visible: false,
                    }
                ],
                plotOptions: {
                    series: {
                        visible: false,

                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function (e) {
                                    var m_id = e.point.movie_id;
                                    if (m_id) {
                                        var data = get_data();

                                        var whait_html = '<div class="cssload-circle">\n' +
                                            '\t\t<div class="cssload-up">\n' +
                                            '\t\t\t\t<div class="cssload-innera"></div>\n' +
                                            '\t\t</div>\n' +
                                            '\t\t<div class="cssload-down">\n' +
                                            '\t\t\t\t<div class="cssload-innerb"></div>\n' +
                                            '\t\t</div>\n' +
                                            '</div>';

                                        $('div.footer_table_result').html(whait_html);

                                        $.ajax({
                                            type: "POST",
                                            url: "get_data.php",

                                            data: ({
                                                oper: 'movie_data',
                                                id: m_id,

                                                data: JSON.stringify(data),
                                                cat: $('.actos_range_category').val()
                                            }),
                                            success: function (html) {
                                                $('.footer_table_result').html('<div class="clear_table"></div><div class="movie_content" id="' + m_id + '">' + html + '</div>');


                                            }
                                        });


                                    }
                                }
                            }
                        }

                    },
                    bellcurve: {
                        visible: true,
                        tooltip: {
                            useHTML: true,
                            headerFormat: '<p>{series.name}</p><br>',

                            <?php if ($display_select == 'bellcurve') {
                                echo "pointFormat:   '<p>{point.x:.0f}%</p>',";
                            } else if ($display_select == 'plurality_bellcurve') {
                                if ($display_xa_axis == 'Movie release date') {
                                    echo "pointFormat:'<p>%  {point.y:.0f}</p>',";
                                } else {
                                    echo "pointFormat:'<p>" . $display_xa_axis . "  $  {point.x:.0f}</p>',";
                                }

                            } ?>


                        }

                    },
                    scatter: {
                        marker: {
                            radius: 5,
                            states: {
                                hover: {
                                    enabled: true,

                                }
                            }
                        },
                        states: {
                            hover: {
                                marker: {
                                    enabled: false
                                }
                            }
                        },


                        tooltip: {
                            useHTML: true,
                            headerFormat: '<p>{series.name}</p><br>',
                            <?php if ($display_select == 'bellcurve') { ?>
                            pointFormat: '<p style="font-size: 14px;color: #0A9BD6;font-weight: bold">{point.title}</p><br><p style="color: #8F8F8F;" ><?php echo $display_xa_axis ?> $ {point.y}</p><br><p>Percent: {point.x} %</p><br><p style="font-size: 10px">Release date: {point.date}</p>',

                            <?php } else  if ($display_select == 'plurality_bellcurve') { ?>

                            pointFormat: '<p style="font-size: 14px;color: #0A9BD6;font-weight: bold">{point.title}</p><br><p style="color: #8F8F8F;" ><?php echo $display_xa_axis ?> $ {point.x}</p><br><p>Percent: {point.y} %</p><br><p style="font-size: 10px">Release date: {point.date}</p>',

                            <?php } ?>
                        }

                    }
                },
                series: [

                    <?php echo $result_data_bell . $result_data; ?>

                ]
            });

            //   console.log(chart.series);

            /*
            var array_remove = new Array();

            $.each(chart.series, function (a, b) {
                ////  console.log(a,b.userOptions.type);
                if (b.userOptions.type == 'line') {
                    array_remove.push(a);
                    ///

                }
            });
            array_remove = array_remove.reverse();
            $.each(array_remove, function (a, b) {
                //  console.log(b);
                chart.series[b].remove(true);
            });
            */


        </script>


        <?php


    }
    else if ($display_select == 'bubble' || $display_select == 'scatter' || $display_select == 'regression') {
        if ($display_select == 'regression') { ?>

            <script src="js/regression.min.js"></script>


        <?php } ?>
        <script type="text/javascript">

            var regrassion_array = new Object();

            <?php   if ( $display_select == 'regression'){ ?>

            function getregression(data, name) {


                var resultr = regression.linear(data, {precision: 100});
                ////  console.log(resultr);
                var points = resultr.points;

                regrassion_array[name] = (resultr.string);
                return points;

            }
            <?php } ?>




            Highcharts.chart('chart_div', {
                chart: {

                    <?php if ($display_select != 'regression') {
                        echo "type: 'scatter',";
                    }?>

                    zoomType: 'xy',
                    ///styledMode: true
                },
                title: {
                    text: '<?php if ($display_select == 'bubble') {
                        echo 'Plurality Scatterplot';
                    } else if ($display_select == 'scatter') {
                        echo 'Scatter Chart by percent';
                    } ?>'
                },

                xAxis: {
                    title: {
                        <?php {
                            echo "text: '" . $display_xa_axis . "'";
                        } ?>
                    },

                    <?php if ($display_xa_axis == 'Movie release date') { ?>
                    type: 'datetime',
                    <?php } ?>
                    startOnTick: true,
                    endOnTick: true,
                    showLastLabel: true,

                    dateTimeLabelFormats: {

                        //  year: '%Y'
                    },
                },
                yAxis: {
                    title: {<?php    echo "text: 'Percent'";   ?>

                    }
                },
                legend: {
                    maxHeight: 70,
                },

                <?php if ($display_select == 'regression') { ?>

                tooltip: {
                    formatter: function (tooltip) {
                        var type = this.series.userOptions.type;
                        if (type == 'spline') {
                            ///   console.log(type);
                            return '<p>' + this.series.name + '</p><br><i style="font-size: 15px;color: #0A9BD6;">' + regrassion_array[this.series.name] + '</i><br><p style="color: #8F8F8F;" ><?php echo $display_xa_axis; ?>: $ ' + (this.x).toFixed(0) + '</p><br><p>Percent: ' + (this.y).toFixed(2) + '%</p>';
                        } else return tooltip.defaultFormatter.call(this, tooltip);

                    }
                },
                <?php } ?>

                plotOptions: {
                    series: {
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function (e) {
                                    var m_id = e.point.movie_id;
                                    var data = get_data();

                                    var whait_html = '<div class="cssload-circle">\n' +
                                        '\t\t<div class="cssload-up">\n' +
                                        '\t\t\t\t<div class="cssload-innera"></div>\n' +
                                        '\t\t</div>\n' +
                                        '\t\t<div class="cssload-down">\n' +
                                        '\t\t\t\t<div class="cssload-innerb"></div>\n' +
                                        '\t\t</div>\n' +
                                        '</div>';

                                    $('div.footer_table_result').html(whait_html);

                                    $.ajax({
                                        type: "POST",
                                        url: "get_data.php",

                                        data: ({
                                            oper: 'movie_data',
                                            id: m_id,

                                            data: JSON.stringify(data),
                                            cat: $('.actos_range_category').val()
                                        }),
                                        success: function (html) {
                                            $('.footer_table_result').html('<div class="clear_table"></div><div class="movie_content" id="' + m_id + '">' + html + '</div>');


                                        }
                                    });


                                }
                            }
                        }
                    },
                    spline: {},
                    scatter: {
                        marker: {
                            radius: 3,
                            states: {
                                hover: {
                                    enabled: true,
                                    lineColor: 'rgb(100,100,100)'
                                }
                            }
                        },
                        states: {
                            hover: {
                                marker: {
                                    enabled: false
                                }
                            }
                        },


                        tooltip: {
                            useHTML: true,
                            headerFormat: '<p>{series.name}</p><br>',

                            <?php if ($display_select == 'bubble' ) {?>
                            pointFormat: '<p style="font-size: 14px;color: #0A9BD6;font-weight: bold">{point.title}</p><br>Percent: {point.y}%<br><p style="color: #8F8F8F;" ><?php echo $display_xa_axis; ?>: $ {point.x}</p><br>{point.content}<br><p style="font-size: 10px">Release date: {point.date}</p>',
                            <?php } else { ?>
                            pointFormat: '<p style="font-size: 14px;color: #0A9BD6;font-weight: bold">{point.title}</p><br><p style="color: #8F8F8F;" ><?php echo $display_xa_axis; ?>: $ {point.x}</p><br>Percent: {point.y}%<br><p style="font-size: 10px">Release date: {point.date}</p>',
                            <?php } ?>
                        }

                    }
                },
                series: [<?php echo $result_data; ?>]
            });

        </script>


        <?php


    }
    else if ($DomesticBox || $International || $byCountry || $result) {
        ?>

        <script type="text/javascript">
            $(document).ready(function () {


                var chart = Highcharts.chart('chart_div', {
                    chart: {
                        type: 'column',
                        zoomType: 'x',
                        ///styledMode: true
                    },
                    title: {
                        text: 'Box Office by year'
                    },
                    legend: {
                        maxHeight: 70,
                    },
                    xAxis: {
                        startOnTick: true,
                        endOnTick: true,
                    },
                    yAxis: {
                        // min: 0,
                        <?php if ($diversity_select == 'diversity') {
                            echo "min: 0,max: 1,";
                        } ?>
                        title: {

                            <?php if ($display_select == 'ethnicity' && $display_xa_axis != 'Movie release date') {
                                echo "text: '" . $display_xa_axis . "'";
                            } else {
                                echo "text: 'Total Box Office'";
                            } ?>

                        }
                    },
                    tooltip: {


                        <?php if ($diversity_select == 'diversity') { ?>

                        pointFormat: '<span >{series.name}</span>: <b> {point.y}</b>',

                        <?php } else { ?>
                        pointFormat: '<span >{series.name}</span>: <b>({point.percentage:.0f}%)</b><br/><?php if ($display_select == 'ethnicity') {
                            echo $display_xa_axis;
                        }?> $ {point.y}',
                        <?php  } ?>
                        //shared: true
                    },
                    plotOptions: {
                        column: {
                            stacking: 'normal',

                            ///  stacking: 'percent'
                        },
                        series: {
                            // pointPadding: 0, // Defaults to 0.1
                            groupPadding: 0.02,// Defaults to 0.2
                            cursor: 'pointer',
                            point: {
                                events: {
                                    click: function (e) {
                                        ///console.log(e);

                                        var m_id = e.point.x;
                                        get_inner(m_id);
                                    }
                                }
                            }
                        },


                    },
                    series: [<?php echo $result_data; ?>]
                });


                $('.change_stack ').click(function () {
                    var stack = $(this).attr('id');

                    if (stack == 'percent') {
                        $(this).attr('id', 'normal').html('Stacking by Box Office');

                    } else {
                        $(this).attr('id', 'percent').html('Stacking by percent');
                    }


                    var s = chart.series;
                    var sLen = s.length;

                    for (var i = 0; i < sLen; i++) {
                        s[i].update({
                            stacking: stack
                        }, false);
                    }
                    chart.redraw();


                });

            });


        </script>
        <button class="change_stack button_big" id="percent">Stacking by percent</button>
        <!--<button class="reverse_aix button_big" id="percent">Reverse the x and y axes</button>-->
        <?php
    }
    else if ($display_select == 'ethnicity') {
        ?>

        <script type="text/javascript">
            $(document).ready(function () {


                var chart = Highcharts.chart('chart_div', {
                    chart: {
                        type: 'column',
                        zoomType: 'x',
                        ///styledMode: true
                    },
                    title: {
                        text: 'Ethnicity by year'
                    },
                    legend: {
                        maxHeight: 70,
                    },
                    xAxis: {
                        startOnTick: true,
                        endOnTick: true,
                    },
                    yAxis: {

                        title: {
                            text: 'Casting Representation'
                        },
                        // min: 0,max: 100,
                    },
                    tooltip: {

                        pointFormat: '<span >{series.name}</span>: <b>{point.percent} % </b><br><p>Box Office per Race: $ {point.y:.0f}</p><br><p>Box Office Total: $ {point.totalbox:.0f}</p>',

                        //shared: true
                    },
                    plotOptions: {
                        column: {
                            //stacking: 'normal',

                            stacking: 'percent'
                        },
                        series: {
                            // pointPadding: 0, // Defaults to 0.1
                            groupPadding: 0.02,// Defaults to 0.2
                            cursor: 'pointer',
                            point: {
                                events: {
                                    click: function (e) {
                                        ///console.log(e);

                                        var m_id = e.point.x;
                                        get_inner(m_id);
                                    }
                                }
                            }
                        },


                    },
                    series: [<?php echo $result_data; ?>]
                });


                $('.change_stack ').click(function () {
                    var stack = $(this).attr('id');

                    if (stack == 'percent') {
                        $(this).attr('id', 'normal').html('Stacking by Cast Member Per Race');

                    } else {
                        $(this).attr('id', 'percent').html('Stacking by Cast Percentage');
                    }


                    var s = chart.series;
                    var sLen = s.length;

                    for (var i = 0; i < sLen; i++) {
                        s[i].update({
                            stacking: stack
                        }, false);
                    }
                    chart.redraw();


                });

            });


        </script>
        <button class="change_stack button_big" id="normal">Stacking by Cast Member Per Race</button>
        <?php
    }
    else if ($display_select == 'performance_country') {
        ?>


        <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.css">

        <script type="text/javascript">
            $(document).ready(function () {


                var chart = Highcharts.chart('chart_div', {
                    chart: {
                        //zoomType: 'x',
                        ///styledMode: true,
                        panning: true,

                    },

                    title: {
                        text: 'Box Office'
                    },
                    legend: {
                        maxHeight: 70,
                    },
                    xAxis: [{
                        categories: [<?php echo $categories; ?>],
                        crosshair: true,
                        min: 0,
                        max: 12,

                        scrollbar: {
                            enabled: true
                        },
                        tickLength: 0
                    }],
                    yAxis: [{ // Primary yAxis
                        gridLineWidth: 0,
                        title: {
                            text: 'Box Office per movie',

                        },
                        opposite: true

                    }, { // Secondary yAxis
                        gridLineWidth: 0,
                        title: {
                            text: 'Box Office total',
                        },

                    }, { // Tertiary yAxis
                        gridLineWidth: 0,
                        title: {
                            text: '%',

                        },
                        visible: false,
                        opposite: true,
                        min: 0, max: 100,
                    }],
                    tooltip: {
                        shared: true,

                        plotOptions: {
                            column: {
                                stacking: 'normal'
                                ///  stacking: 'percent'
                            },


                        }

                    },

                    plotOptions: {
                        column: {
                            stacking: 'normal'
                            ///  stacking: 'percent'
                        },
                        series: {
                            // pointPadding: 0, // Defaults to 0.1
                            groupPadding: 0.02,// Defaults to 0.2
                            point: {
                                events: {
                                    click: function (e) {

                                        var category = e.point.category;
                                        var data = get_data();

                                        var whait_html = '<div class="cssload-circle">\n' +
                                            '\t\t<div class="cssload-up">\n' +
                                            '\t\t\t\t<div class="cssload-innera"></div>\n' +
                                            '\t\t</div>\n' +
                                            '\t\t<div class="cssload-down">\n' +
                                            '\t\t\t\t<div class="cssload-innerb"></div>\n' +
                                            '\t\t</div>\n' +
                                            '</div>';

                                        $('div.footer_table_result').html(whait_html);

                                        $.ajax({
                                            type: "POST",
                                            url: "get_data.php",

                                            data: ({
                                                oper: 'get_chart_by_country',
                                                id: category,

                                                data: JSON.stringify(data),
                                                cat: $('.actos_range_category').val()
                                            }),
                                            success: function (html) {


                                                $('.footer_table_result').html('<div class="clear_table"></div><div class="movie_content" id="' + category + '">' + html + '</div>');
                                                get_ajax_cast_total(category, 'country');

                                            }
                                        });


                                    }
                                }
                            }
                        },

                    },


                    series: [<?php echo $result_data; ?>]
                });


                document.querySelectorAll('#button-row button').forEach(function (button) {
                    button.addEventListener('click', function () {
                        chart.series[0].update({
                            type: button.className.split('-')[0]
                        });
                        chart.series[1].update({
                            type: button.className.split('-')[0]
                        });
                    });
                });


            });


        </script>
        <div id="button-row">
            <button class="spline-chart"><i class="fa fa-line-chart"></i></button>
            <button class="areaspline-chart"><i class="fa fa-area-chart"></i></button>

        </div>

        <?php


    }


}